이번 과정에서는 이전의 Nginx 및 파이썬 웹 서버 프로젝트에 이어, **Terragrunt(테라그런트)**를 통해 **MySQL(마이 SQL)** 데이터베이스를 **Kubernetes(쿠버네티스)** 클러스터에 배포하는 실습을 진행합니다. 데이터베이스는 상태를 유지해야 하므로 환경 변수 설정과 함께 1개의 복제본으로 구성합니다.

---

## 1. 프로젝트 디렉토리 생성

기존 `k8s-project` 구조 아래에 MySQL을 위한 모듈과 배포 환경을 추가합니다.

```bash
# 프로젝트 루트로 이동
cd ~/k8s-project

# 신규 모듈 및 배포 디렉토리 생성
mkdir -p modules/mysql-deploy
mkdir -p live/dev/mysql

```

최종적으로 다음과 같은 구조가 확장됩니다.

```text
k8s-project/
├── modules/
│   ├── nginx-deploy/
│   ├── python-web/
│   └── mysql-deploy/    # 신규 MySQL 모듈
└── live/
    └── dev/
        ├── nginx/
        ├── python-web/
        └── mysql/        # 신규 MySQL 배포 설정

```

---

## 2. 테라폼 모듈 작성 (`modules/mysql-deploy/`)

### 2.1 `modules/mysql-deploy/main.tf`

MySQL 공식 이미지를 사용하며, 접속을 위한 루트 비밀번호를 환경 변수로 설정합니다.

```hcl
resource "kubernetes_deployment_v1" "mysql" {
  metadata {
    name = var.db_name
    labels = {
      app = "mysql"
    }
  }

  spec {
    replicas = 1  # DB 일관성을 위해 1개로 설정

    selector {
      match_labels = {
        app = "mysql"
      }
    }

    template {
      metadata {
        labels = {
          app = "mysql"
        }
      }

      spec {
        container {
          name  = "mysql-container"
          image = "mysql:8.0"

          # MySQL 구동을 위한 필수 환경 변수 설정
          env {
            name  = "MYSQL_ROOT_PASSWORD"
            value = var.root_password
          }

          port {
            container_port = 3306
          }
        }
      }
    }
  }
}

```

### 2.2 `modules/mysql-deploy/variables.tf`

```hcl
variable "db_name" {
  description = "데이터베이스 디플로이먼트 이름"
  type        = string
  default     = "mysql-db"
}

variable "root_password" {
  description = "MySQL 루트 사용자 비밀번호"
  type        = string
  sensitive   = true  # 보안을 위해 출력 시 숨김 처리
}

```

---

## 3. Terragrunt 설정 작성 (`live/dev/mysql/`)

### 3.1 `live/dev/mysql/terragrunt.hcl`

```hcl
# MySQL 모듈 소스 경로 설정
terraform {
  source = "../../../modules/mysql-deploy"
}

# 쿠버네티스 공급자 설정 자동 생성
generate "provider" {
  path      = "provider.tf"
  if_exists = "overwrite_terragrunt"
  contents  = <<EOF
provider "kubernetes" {
  config_path = "~/.kube/config"
}
EOF
}

# 입력값 주입
inputs = {
  db_name       = "dev-mysql-server"
  root_password = "password123!" # 실무에서는 별도의 Secret(시크릿) 관리 필요
}

```

---

## 4. 인프라 배포 및 확인

### 4.1 배포 실행

```bash
cd ~/k8s-project/live/dev/mysql/

# 초기화 및 배포
terragrunt init
terragrunt apply

```

### 4.2 결과 확인

```bash
# MySQL 포드 생성 확인
kubectl get pods -l app=mysql

# MySQL 내부 접속 테스트 (포드 이름 확인 후 실행)
kubectl exec -it <MYSQL_POD_NAME> -- mysql -u root -p

```

> **주석 (Note)**
> * **Environment Variable (환경 변수)**: 프로세스가 구동될 때 참조하는 동적 값입니다. MySQL 컨테이너는 `MYSQL_ROOT_PASSWORD` 변수가 반드시 설정되어야 구동됩니다.
> * **Sensitive (민감 정보)**: 테라폼에서 `sensitive = true`를 설정하면 로그나 터미널 출력 시 해당 값이 `(sensitive value)`로 가려집니다.
> * **Port 3306**: MySQL의 기본 통신 포트 번호입니다.
> 
> 

---

Next Step: **Persistent Volume(퍼시스턴트 볼륨) 설정을 통한 데이터 보존**

본 실습은 사용자 **Ubuntu VM** 내부 자원을 사용하므로 별도의 AWS 과금은 발생하지 않습니다. 다만, 실제 클라우드 환경에서 **EBS(Elastic Block Store)**와 같은 스토리지 볼륨을 생성하여 연결할 경우 해당 크기에 따른 월별 사용료가 부과됩니다.

배포 완료.
준비된 교재 형식을 확인해 보세요.
