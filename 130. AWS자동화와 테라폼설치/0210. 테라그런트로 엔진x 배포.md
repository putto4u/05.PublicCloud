이번 과정에서는 **Terragrunt(테라그런트)**를 사용하여 **Terraform(테라폼)** 코드를 효율적으로 관리하고, 이를 통해 **Ubuntu VM(우분투 가상 머신)** 내의 **Kubernetes(쿠버네티스)** 클러스터에 **Nginx(엔진엑스)** 디플로이먼트를 3개의 복제본(Replicas)으로 배포하는 실습을 진행합니다.

---

## 1. 개요 및 환경 준비

**Terragrunt(테라그런트)**는 테라폼의 구성을 `DRY(Don't Repeat Yourself)` 원칙에 따라 관리할 수 있게 해주는 래퍼(Wrapper) 도구입니다.

### 1.1 Terragrunt 설치

우분투 환경에서 최신 버전의 Terragrunt를 설치합니다. (Terraform이 먼저 설치되어 있어야 합니다.)

```bash
# Terraform 설치 확인
terraform -version

# Terragrunt 다운로드 및 설치 (x86_64 기준)
wget https://github.com/gruntwork-io/terragrunt/releases/latest/download/terragrunt_linux_amd64
chmod +x terragrunt_linux_amd64
sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

# 설치 확인
terragrunt -version

```

---

## 2. 프로젝트 디렉토리 구조

Terragrunt는 디렉토리 구조 자체가 인프라의 구조를 나타냅니다. 모듈(소스 코드)과 실 배포 환경(설정 값)을 분리하여 구성합니다.

```text
k8s-project/
├── modules/                # 재사용 가능한 테라폼 코드 (원본)
│   └── nginx-deploy/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf
└── live/                   # 실제 배포 환경 설정 (Terragrunt)
    └── dev/
        └── nginx/
            └── terragrunt.hcl

```

---

## 3. 테라폼 모듈 작성 (`modules/`)

### 3.1 `modules/nginx-deploy/main.tf`

Kubernetes Provider(쿠버네티스 공급자)를 사용하여 Nginx를 배포하는 기본 코드입니다.

```hcl
resource "kubernetes_deployment_v1" "nginx" {
  metadata {
    name      = var.deployment_name
    namespace = "default"
    labels = {
      app = "nginx"
    }
  }

  spec {
    replicas = var.replica_count

    selector {
      match_labels = {
        app = "nginx"
      }
    }

    template {
      metadata {
        labels = {
          app = "nginx"
        }
      }

      spec {
        container {
          image = "nginx:latest"
          name  = "nginx-container"

          port {
            container_port = 80
          }
        }
      }
    }
  }
}

```

### 3.2 `modules/nginx-deploy/variables.tf`

변경 가능한 변수들을 정의합니다.

```hcl
variable "deployment_name" {
  description = "디플로이먼트의 이름"
  type        = string
  default     = "nginx-deployment"
}

variable "replica_count" {
  description = "생성할 Pod(포드)의 개수"
  type        = number
  default     = 3
}

```

---

## 4. Terragrunt 설정 작성 (`live/`)

### 4.1 `live/dev/nginx/terragrunt.hcl`

이 파일은 `modules`에 있는 코드를 호출하며, 실제 배포될 값을 주입합니다.

```hcl
# 호출할 모듈 소스 경로 설정
terraform {
  source = "../../../modules/nginx-deploy"
}

# 쿠버네티스 접속 설정 (Provider 블록 자동 생성)
generate "provider" {
  path      = "provider.tf"
  if_exists = "overwrite_terragrunt"
  contents  = <<EOF
provider "kubernetes" {
  config_path = "~/.kube/config"
}
EOF
}

# 변수 입력 (입력값 주입)
inputs = {
  deployment_name = "dev-nginx-server"
  replica_count   = 3
}

```

---

## 5. 인프라 배포 및 확인

### 5.1 실행 과정

`live/dev/nginx/` 디렉토리로 이동하여 명령어를 실행합니다.

```bash
cd ~/k8s-project/live/dev/nginx/

# 초기화 (Terraform init 및 모듈 복사 수행)
terragrunt init

# 실행 계획 확인
terragrunt plan

# 실제 배포 수행
terragrunt apply

```

### 5.2 결과 확인

배포가 완료되면 `kubectl` 명령어를 통해 상태를 확인합니다.

```bash
# 디플로이먼트 및 포드 확인
kubectl get deployments
kubectl get pods -o wide

```

> **주석 (Note)**
> * **Kubernetes Provider (쿠버네티스 공급자)**: 테라폼이 쿠버네티스 API와 통신하여 리소스를 생성할 수 있게 해주는 플러그인입니다.
> * **DRY (Don't Repeat Yourself)**: 동일한 코드를 반복하지 말라는 소프트웨어 개발 원칙입니다.
> * **config_path**: 우분투 VM에 설치된 k8s 클러스터의 인증 정보 파일(`~/.kube/config`) 경로입니다.
> 
> 

---

Next Step: **Kubernetes Service(쿠버네티스 서비스) 배포 및 NodePort 노출** (무료 서비스)

이전에 안내해 드린 대로, 본 실습은 본인 소유의 **Ubuntu VM** 내부 자원을 사용하므로 별도의 AWS 비용은 발생하지 않습니다. 다만, 추후 클라우드 환경으로 전환 시 **Load Balancer(로드 밸런서)** 서비스 사용 시에는 과금이 발생할 수 있음을 유의해 주세요.
