이번 과정에서는 **Terragrunt(테라그런트)**를 사용하여 인프라의 상태를 저장하는 **Backend(백엔드)** 설정 방법을 실습합니다.

일반적으로 클라우드에서는 S3를 사용하지만, 현재 환경인 **Ubuntu VM(마스터 서버)**의 로컬 디렉토리(`~/backend`)를 백엔드로 지정하여 상태 파일(`terraform.tfstate`)을 중앙 관리하는 구조를 설계합니다.

---

## 1. 백엔드(Backend)의 역할

테라폼은 리소스의 현재 상태를 기록하는 `terraform.tfstate` 파일을 생성합니다.

* **중앙 관리**: 여러 프로젝트가 하나의 경로를 참조하여 상태를 관리합니다.
* **코드 재사용**: 각 프로젝트마다 백엔드 설정을 반복해서 적지 않고, Terragrunt가 자동으로 생성하도록 만듭니다.

---

## 2. 백엔드 저장소 준비 (마스터 서버)

먼저 상태 파일들이 저장될 물리적인 디렉토리를 생성합니다.

```bash
# 마스터 서버(192.168.100.251)에서 실행
mkdir -p ~/backend

```

---

## 3. Terragrunt 프로젝트 구조 설계

Terragrunt의 가장 큰 장점은 **상위 경로의 설정을 하위 프로젝트들이 상속**받을 수 있다는 점입니다.

```text
k8s-project/
├── terragrunt.hcl          # [중요] 공통 백엔드 설정을 담은 루트 설정 파일
├── live/
│   └── dev/
│       ├── nginx/
│       │   └── terragrunt.hcl  # 루트 설정을 상속받음
│       └── mysql/
│           └── terragrunt.hcl  # 루트 설정을 상속받음

```

---

## 4. 루트 설정 파일 작성 (`k8s-project/terragrunt.hcl`)

이 파일은 모든 하위 모듈이 공통으로 사용할 **백엔드 구성**을 정의합니다. `local` 백엔드를 사용하여 지정하신 경로에 상태 파일을 저장하도록 설정합니다.

```hcl
# k8s-project/terragrunt.hcl

remote_state {
  backend = "local"
  generate = {
    path      = "backend.tf"
    if_exists = "overwrite_terragrunt"
  }
  config = {
    # 각 프로젝트의 경로에 맞춰 자동으로 파일명을 생성하도록 설정
    path = "/home/사용자명/backend/${path_relative_to_include()}/terraform.tfstate"
  }
}

```

* **주의**: `/home/사용자명/` 부분은 실제 마스터 서버의 계정명에 맞게 절대 경로로 수정해 주세요.

---

## 5. 하위 프로젝트 설정 수정

이제 각 서비스(`nginx`, `mysql` 등)의 `terragrunt.hcl` 파일 상단에 루트 설정을 불러오는 코드를 추가합니다.

### 5.1 `live/dev/nginx/terragrunt.hcl` 예시

```hcl
# 루트 terragrunt.hcl 설정을 상속받음
include "root" {
  path = find_in_parent_folders()
}

terraform {
  source = "../../../modules/nginx-deploy"
}

# (이후 기존 입력값 설정...)

```

---

## 6. 백엔드 적용 및 확인

### 6.1 초기화 실행

```bash
cd ~/k8s-project/live/dev/nginx/
terragrunt init

```

* 실행 시 `backend.tf` 파일이 자동으로 생성되며, "Initializing the backend..." 메시지가 출력됩니다.

### 6.2 상태 파일 확인

실제로 배포(`apply`)를 수행한 뒤, 지정한 경로에 파일이 생겼는지 확인합니다.

```bash
# 배포 실행
terragrunt apply -auto-approve

# 백엔드 저장소 확인
ls -R ~/backend

```

정상적으로 설정되었다면 `~/backend/live/dev/nginx/terraform.tfstate` 경로에 파일이 생성되어 있을 것입니다.

---

## 7. 학습 요약 및 실무 팁

> **주석 (Note)**
> * **find_in_parent_folders()**: 현재 위치에서 상위 디렉토리로 올라가며 가장 가까운 `terragrunt.hcl` 파일을 자동으로 찾아주는 함수입니다.
> * **path_relative_to_include()**: 루트 설정 파일과 현재 파일 사이의 상대 경로를 반환합니다. 이를 통해 각 프로젝트별로 상태 파일이 겹치지 않게 저장할 수 있습니다.
> * **Local Backend**: 현재는 단일 서버 실습이므로 로컬 경로를 쓰지만, 실무(AWS)에서는 이를 `s3`로 바꾸고 `bucket`과 `dynamodb_table` 설정을 추가하여 사용합니다.
> 
> 

---

Next Step: **AWS S3와 DynamoDB를 이용한 원격 백엔드(Remote State) 구축** 본 실습은 마스터 서버의 로컬 디스크를 사용하므로 별도의 클라우드 과금이 발생하지 않습니다. 하지만 실무에서 S3 백엔드를 구성할 경우, 상태 파일 저장 용량 및 읽기/쓰기 요청에 따른 미세한 비용과 DynamoDB(Lock 관리용) 비용이 발생할 수 있습니다.

Next Step: S3 원격 백엔드 전환 방법

**요청하신 마스터 서버 경로와 교재 가이드라인에 맞춰 작성되었습니다.**
