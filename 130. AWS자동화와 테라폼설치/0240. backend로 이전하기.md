이번 과정에서는 로컬에서 관리하던 테라폼 상태(State)를 **Terragrunt(테라그런트)**를 활용하여 중앙 집중형 백엔드(`~/backend`)로 안전하게 이전하는 전체 공정을 실습합니다.

단순히 파일만 옮기는 것이 아니라, 설정 수정부터 초기화, 검증까지 한 단계라도 누락되면 기존 인프라 정보가 유실되거나 중복 생성되는 에러가 발생할 수 있습니다. 아래 절차를 엄격히 준수하여 진행합니다.

---

## 1. 사전 준비 및 백업 (Backup)

가장 먼저 해야 할 일은 현재 상태의 '스냅샷'을 찍어두는 것입니다. 이전 작업 중 실수가 발생할 경우를 대비합니다.

```bash
# 마스터 서버에서 현재 프로젝트 루트로 이동
cd ~/k8s-project

# 만약을 대비해 현재의 모든 local tfstate 파일을 안전한 곳으로 복사
mkdir -p ~/state_backup
find . -name "terraform.tfstate" -exec cp --parents {} ~/state_backup/ \;

```

---

## 2. 루트(Root) 설정 파일 작성 및 공통화

모든 하위 프로젝트가 공유할 중앙 백엔드 규칙을 정의합니다.

### 2.1 `~/k8s-project/terragrunt.hcl` 생성

```hcl
# 공통 백엔드 설정 (Remote State 관리)
remote_state {
  backend = "local"
  generate = {
    path      = "backend.tf"
    if_exists = "overwrite_terragrunt"
  }
  config = {
    # path_relative_to_include() 함수를 사용하여 각 서비스별로 경로를 자동 분리
    # path = "/home/사용자계정/backend/${path_relative_to_include()}/terraform.tfstate"
    # 윈도우의 경우 C 드라이브 사용자 폴더를 명시
    path = "C:/Users/B1-MAIN/backend/${path_relative_to_include()}/terraform.tfstate"
}
  }
}

# 공통 Provider 설정 (모든 하위 모듈에 자동 삽입)
generate "provider" {
  path      = "provider.tf"
  if_exists = "overwrite_terragrunt"
  contents  = <<EOF
provider "kubernetes" {
  config_path = "~/.kube/config"
}
EOF
}

```

---

## 3. 각 개별 프로젝트 코드 수정

기존에 개별적으로 작성했던 `terragrunt.hcl` 파일들을 루트 설정을 따르도록 수정합니다. (Nginx, Python-Web, MySQL 각각 수행)

### 3.1 수정 내용 (`live/dev/*/terragrunt.hcl`)

1. **상단에 include 추가**: `include "root" { path = find_in_parent_folders() }`
2. **중복 제거**: 기존에 직접 작성했던 `generate "provider"` 블록은 루트에서 관리하므로 **삭제**합니다.

---

## 4. 상태 이전 실행 (State Migration)

이 단계가 가장 중요합니다. 각 서비스 디렉토리로 이동하여 테라폼이 상태를 옮기도록 유도합니다.

### 4.1 서비스별 순차 이전

```bash
# 예시: Nginx 디렉토리로 이동
cd ~/k8s-project/live/dev/nginx/  #################### 여기까지######################

# 초기화 실행 (Terragrunt가 백엔드 변경을 감지함)
terragrunt init

```

### 4.2 테라폼 프롬프트 응답 (중요)

`init` 실행 시 다음과 같은 질문이 나옵니다.

> **"Do you want to copy existing state to the new backend?"**

* **반드시 `yes`를 입력**합니다.
* **주의**: 만약 `no`를 입력하거나 이 과정이 뜨지 않고 새로 초기화된다면 즉시 중단하고 백업본을 확인해야 합니다.

---

## 5. 이전 결과 검증

데이터가 물리적으로 새 경로에 들어갔는지, 테라폼이 인식을 하는지 확인합니다.

### 5.1 물리적 파일 확인

```bash
# 지정한 백엔드 경로에 파일이 생성되었는지 확인
ls -R ~/backend/live/dev/nginx/

```

### 5.2 리소스 매칭 확인

```bash
# 상태 파일을 읽어 현재 배포된 리소스를 제대로 인식하는지 확인
terragrunt plan

```

* **성공**: "No changes. Your infrastructure matches the configuration." 메시지가 떠야 합니다.
* **실패**: 만약 많은 리소스가 `to add`로 뜬다면 상태 이전이 실패한 것이며, 그대로 `apply`하면 에러가 발생합니다.

---

## 6. 전체 프로젝트 동기화 및 마무리

나머지 서비스(`python-web`, `mysql`)도 위 4~5번 과정을 동일하게 반복합니다. 모든 서비스의 이전이 끝나면 `run-all` 명령어로 전체 상태를 최종 점검합니다.

```bash
cd ~/k8s-project/live/dev/
terragrunt run-all plan

```

---

## 7. 핵심 체크리스트

> **주석 (Note)**
> * **절대 경로 사용**: `terragrunt.hcl`의 백엔드 경로 설정 시 반드시 `/home/계정명/...`과 같은 절대 경로를 사용해야 에러가 없습니다.
> * **중복 파일 정리**: 이전이 성공했다면 기존 디렉토리에 남은 로컬 `terraform.tfstate` 파일은 삭제하거나 무시해도 안전합니다.
> * **Backend.tf 자동 생성**: Terragrunt는 실행 시 `backend.tf`를 자동으로 생성하므로, 이 파일을 직접 수정하지 마세요.
> 
> 

---

Next Step: **Terragrunt를 활용한 Variable(변수) 관리 체계 고도화**

본 실습은 로컬 파일 시스템 내에서의 이동이므로 추가적인 클라우드 과금은 발생하지 않습니다. 상태 파일은 텍스트 파일이므로 용량 또한 매우 작아 디스크 비용 걱정 없이 관리가 가능합니다.

Next Step: 변수 관리 고도화 방법

**모든 이전 단계와 주의사항을 빠짐없이 포함하여 교재 형식으로 작성되었습니다.**
