강의 교재의 완성도를 높이기 위해, **Terragrunt(테라그란트)** 프로젝트의 표준 디렉토리 구조를 최상단에 배치하여 전체적인 흐름을 한눈에 파악할 수 있도록 재구성하였습니다.

---

## [강의 실습] Terragrunt 기반 AWS 인프라 관리 및 완전 삭제 가이드

### 0. 프로젝트 디렉토리 구조 (Directory Structure)

실무에서 가장 많이 사용되는 **계층형 구조**입니다. 각 디렉토리는 독립적인 상태 파일(`tfstate`)을 가지며 의존성을 관리합니다.

```text
.
├── terragrunt.hcl          # 전체 환경 공통 설정 (S3 백엔드 등)
├── prod                    # 운영(Production) 환경
│   ├── vpc                 # VPC 모듈 (IGW, NAT 포함)
│   │   └── terragrunt.hcl
│   ├── eks                 # EKS 클러스터 모듈
│   │   └── terragrunt.hcl
│   └── services            # EC2, RDS 등 서비스 모듈
│       └── terragrunt.hcl
└── modules                 # 실제 테라폼 코드 (Reusable Modules)
    ├── vpc/main.tf
    ├── eks/main.tf
    └── storage/main.tf     # S3, EBS 관련 설정 포함

```

---

## 1. 기존 인프라 정보 수집 및 코드화 (Reverse Engineering)

수동으로 생성된 자원을 테라폼 관리 엔진에 등록하는 과정입니다.

### 1.1. 실행 명령어: 기존 리소스 연결 (Import)

```bash
# 1. 해당 리소스 디렉토리로 이동
cd prod/vpc

# 2. 테라그란트 초기화 (Backend 엔진 연결)
terragrunt init

# 3. 기존 VPC를 테라폼 상태 파일에 강제 등록 (VPC ID는 실제 값 입력)
# 이 작업을 통해 수동 생성 자원이 테라폼 관리하에 놓이게 됩니다.
terragrunt import aws_vpc.this vpc-0123456789abcdef0

```

---

## 2. 완벽한 삭제를 위한 엔진 설정 (HCL)

삭제 명령 시 오류를 방지하기 위해 각 모듈의 **강제 삭제(Force Destroy)** 파라미터를 활성화합니다.

### 2.1. S3 및 EBS 강제 삭제 설정

**파일 경로:** `modules/storage/main.tf`

```hcl
resource "aws_s3_bucket" "data_store" {
  bucket        = "my-app-storage"
  force_destroy = true # 버킷 내부 파일이 있어도 무시하고 삭제하는 엔진 설정
}

resource "aws_instance" "worker_node" {
  # ... (생략) ...
  root_block_device {
    delete_on_termination = true # 인스턴스 종료 시 EBS 볼륨을 즉시 제거
  }
}

```

---

## 3. 실습 종료: 인프라 전체 삭제 프로세스 (Total Clean-up)

비용 발생을 0으로 만들기 위해 아래 순서에 따라 삭제 엔진을 가동합니다.

### 3.1. 1단계: 외부 동적 리소스 선제 삭제

EKS 엔진이 생성한 유료 로드밸런서와 볼륨을 먼저 제거해야 합니다.

```bash
# 모든 네임스페이스의 서비스(LoadBalancer)를 삭제하여 ELB 제거
kubectl delete svc --all --all-namespaces

# 영구 볼륨(PVC) 삭제를 통해 연결된 유료 EBS 볼륨 정리
kubectl delete pvc --all --all-namespaces

```

### 3.2. 2단계: Terragrunt를 이용한 전체 삭제 실행

```bash
# 최상위 디렉토리(prod)에서 모든 하위 모듈을 의존성 역순으로 삭제
terragrunt destroy-all --terragrunt-non-interactive

```

---

## 전문 용어 및 개념 설명

* **Directory Structure (디렉토리 구조):** 리소스를 논리적으로 분리하여 관리하고, 영향 범위를 최소화하기 위한 파일 구성 방식입니다.
* **Import (임포트, 가져오기):** 이미 생성된 외부 리소스를 테라폼의 상태 파일(`tfstate`)로 편입시키는 작업입니다.
* **Force Destroy (강제 삭제):** 내부 데이터나 종속성이 있어도 무시하고 리소스를 제거하도록 명령하는 엔진 파라미터입니다.
* **Delete on Termination (종료 시 삭제):** EC2 인스턴스가 삭제될 때 연결된 가상 디스크(EBS)의 생명주기를 같이 마감하는 설정입니다.

---

## 실습 후 비용 체크리스트 (Final Audit)

| 항목 | 확인 메뉴 | 상태 (Desired State) |
| --- | --- | --- |
| **NAT Gateway** | VPC > NAT Gateways | `Deleted` 확인 (유료 엔진) |
| **Elastic IP** | EC2 > Elastic IPs | `Release` (할당 해제) 필수 |
| **EKS Cluster** | EKS > Clusters | 리스트에서 사라진 것 확인 |
| **EBS Volume** | EC2 > Volumes | `Available` 상태인 찌꺼기 볼륨 확인 및 삭제 |

> **실전 팁(Expert Tip):** `terragrunt destroy-all` 이후에도 반드시 AWS Billing Dashboard(결제 대시보드)에서 현재 가동 중인 리소스(Active Resources)를 확인하여 예상치 못한 과금을 방지하세요.

Next Step: Terragrunt 의존성(Dependency) 최적화 및 속도 향상 기법

---

**Acknowledgment:** 사용자의 요청에 따라 전체 디렉토리 구조를 최상단에 배치하여 직관성을 높였습니다. 깃허브 업로드가 용이하도록 마크다운 형식을 철저히 준수하였으며, IT 전문가 강사님의 스타일대로 핵심 정보를 명확히 전달하도록 구성했습니다.
