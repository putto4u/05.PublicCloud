*(개인 메시지: 요청하신 퍼블릭/프라이빗 서브넷 기반의 2-Tier(투-티어) 웹 서버 배포 및 검증 과정 교재입니다. 이전 VPC 구성과 이어지도록 설계하였으며, 아키텍트 관점에서 프라이빗 망의 접근 한계와 해결책(포트 포워딩)을 실무적으로 풀어냈습니다.)*

---

**퍼블릭 웹 서버(Nginx)와 프라이빗 WAS(Python) 프로비저닝 아키텍처**

현대적인 클라우드 아키텍처에서는 보안을 위해 외부 클라이언트와 직접 통신하는 웹 서버와, 내부 비즈니스 로직을 처리하는 WAS(Web Application Server, 웹 애플리케이션 서버)를 물리적/논리적으로 분리합니다. 이번 과정에서는 **Terragrunt(테라그런트)**를 활용하여 이중화된 네트워크 영역에 각각 다른 역할을 하는 **EC2 (Elastic Compute Cloud, 아마존 일래스틱 컴퓨트 클라우드 - *컴퓨팅 시간당 과금 발생*)** 인스턴스를 배포하고 검증합니다.

### 1. 배포 아키텍처 설계

* **Public Instance (krvpc01-subnet1):**
* OS: Ubuntu 22.04 LTS
* 웹 서버: Nginx (포트 80 개방)
* 접근성: 외부 인터넷에서 **EIP (Elastic IP, 탄력적 IP - *인스턴스 중지 시 과금 발생*)**를 통해 직접 브라우저 접속 가능.


* **Private Instance (krvpc01-subnet3):**
* OS: Ubuntu 22.04 LTS
* 웹 서버: Python 3 `http.server` (포트 8000 개방)
* 접근성: 외부 인터넷 접속 불가. 퍼블릭 서브넷의 인스턴스를 경유하거나 포트 포워딩(Port Forwarding)을 통해서만 접근 가능. (*주의: 설치 패키지 다운로드를 위해 이전 VPC 단계에서 NAT Gateway가 활성화되어 있어야 합니다. - NAT 과금 발생*)



### 2. Terragrunt 코드 작성 및 파일 작업

프로젝트 디렉토리 내에 퍼블릭 인스턴스와 프라이빗 인스턴스를 위한 두 개의 폴더를 분리하여 작성합니다.

**1) 퍼블릭 Nginx 인스턴스 구성 (`public_nginx/terragrunt.hcl`)**

```hcl
terraform {
  source = "tfr:///terraform-aws-modules/ec2-instance/aws?version=5.6.0"
}

inputs = {
  name                   = "nginx-public-server"
  instance_type          = "t3.micro"
  ami                    = "ami-04ce2d1589fa3bc42" # Ubuntu 22.04 LTS (ap-northeast-2)
  subnet_id              = "krvpc01-subnet1" # 퍼블릭 서브넷 ID 매핑
  vpc_security_group_ids = ["sg-0123456789abcdef0"] # 80(HTTP), 22(SSH) 개방된 SG 필요
  associate_public_ip_address = true

  # Cloud-init을 통한 Nginx 자동 설치 및 실행
  user_data = <<-EOF
              #!/bin/bash
              apt-get update -y
              apt-get install -y nginx
              systemctl enable nginx
              systemctl start nginx
              EOF

  tags = {
    Environment = "Production"
    Role        = "Web-Frontend"
  }
}

```

**2) 프라이빗 Python 웹 서버 구성 (`private_python/terragrunt.hcl`)**

```hcl
terraform {
  source = "tfr:///terraform-aws-modules/ec2-instance/aws?version=5.6.0"
}

inputs = {
  name                   = "python-private-server"
  instance_type          = "t3.micro"
  ami                    = "ami-04ce2d1589fa3bc42" # Ubuntu 22.04 LTS (ap-northeast-2)
  subnet_id              = "krvpc01-subnet3" # 프라이빗 서브넷 ID 매핑
  vpc_security_group_ids = ["sg-0123456789abcdef1"] # VPC 내부 8000(TCP) 개방된 SG 필요
  associate_public_ip_address = false # 프라이빗 망이므로 퍼블릭 IP 할당 금지

  # Cloud-init을 통한 Python3 웹 서버 백그라운드 실행
  user_data = <<-EOF
              #!/bin/bash
              apt-get update -y
              apt-get install -y python3
              mkdir -p /var/www/app
              echo "<h1>Hello from Private Python Server in subnet3</h1>" > /var/www/app/index.html
              cd /var/www/app
              nohup python3 -m http.server 8000 &
              EOF

  tags = {
    Environment = "Production"
    Role        = "Web-Backend"
  }
}

```

### 3. 인프라스트럭처 실행 (Execution)

엔터프라이즈 환경에서는 의존성을 가진 여러 디렉토리를 한 번에 실행하기 위해 `run-all` 명령어를 사용합니다. 최상위 디렉토리에서 아래 명령을 수행합니다.

```bash
# 하위의 모든 모듈을 한 번에 초기화하고 적용합니다.
terragrunt run-all init
terragrunt run-all apply

```

콘솔에 출력되는 리소스 생성 목록을 확인한 후 `yes`를 입력하여 프로비저닝을 완료합니다.

### 4. 브라우저 접속 및 아키텍처 검증

**1) 퍼블릭 서브넷 (Nginx) 검증**
가장 직관적인 검증입니다. AWS 콘솔에서 `nginx-public-server`의 퍼블릭 IP를 확인한 후, 웹 브라우저 주소창에 `http://<퍼블릭_IP>`를 입력합니다. 기본 Nginx 환영 페이지(Welcome to nginx!)가 정상적으로 렌더링됩니다.

**2) 프라이빗 서브넷 (Python) 검증 (심화)**
프라이빗 서브넷은 외부 인터넷과 단절되어 있으므로 브라우저에서 직접 IP를 입력하여 접속할 수 없습니다. 이를 아키텍처적으로 우회하여 로컬 브라우저에서 확인하려면 **SSH 로컬 포트 포워딩(Local Port Forwarding)**<sup>1</sup> 기술을 사용해야 합니다.

사용자의 터미널에서 다음 명령어를 실행하여 로컬 PC의 8080 포트를 퍼블릭 Nginx 인스턴스를 경유하여 프라이빗 Python 인스턴스의 8000 포트로 연결(터널링)합니다.

```bash
ssh -i "your-key.pem" -L 8080:<프라이빗_인스턴스_IP>:8000 ubuntu@<퍼블릭_인스턴스_IP>

```

터널링이 유지된 상태에서 로컬 웹 브라우저를 열고 `http://localhost:8080`으로 접속하면, 프라이빗 망 깊숙한 곳에서 동작 중인 `"Hello from Private Python Server in subnet3"` 메시지를 성공적으로 확인할 수 있습니다.

### 5. 인프라스트럭처 철거 (Destroy)

클라우드 비용 최적화를 위해 실습이나 테스트가 끝난 인프라는 즉시 회수해야 합니다.

```bash
terragrunt run-all destroy

```

승인 후, EC2 인스턴스와 관련된 스토리지, 보안 그룹 룰 등이 과금되지 않도록 깔끔하게 삭제됩니다.

### 💡 실전 팁 및 자주 하는 오해

> **❌ 흔한 오해: "프라이빗 서브넷에 배치하기만 하면 외부망과 완벽히 격리되므로 안전하게 패키지를 설치하고 운영할 수 있다."**
> **✅ 실전 아키텍트의 관점:**
> 프라이빗 서브넷 내의 인스턴스가 `apt-get update`를 실행하여 Nginx나 Python 패키지를 다운로드하려면 '외부 인터넷으로 나가는 길(Outbound)'이 반드시 열려 있어야 합니다. 따라서 VPC 내에 **NAT Gateway (Network Address Translation Gateway, 네트워크 주소 변환 게이트웨이)**가 존재하지 않으면 `user_data` 스크립트는 조용히 실패(Silent Failure)하고 웹 서버는 구동되지 않습니다.
> **🔥 실전 운영 팁:**
> 만약 NAT Gateway 비용이 부담되어 완전히 폐쇄된 프라이빗 망을 운영해야 한다면, Packer(패커)와 같은 도구를 사용하여 필요한 소프트웨어(Python 등)가 사전에 모두 설치된 **Golden Image (골든 이미지, 배포 가능한 최종 상태의 가상 머신 이미지)** 형태의 자체 AMI(Amazon Machine Image)를 미리 구워두고 이를 호출하는 방식으로 아키텍처를 설계해야 합니다.

---

**용어 설명(주석)**

1. **SSH 로컬 포트 포워딩(Local Port Forwarding)**: 보안 셸(SSH) 연결을 통해 로컬 컴퓨터의 특정 포트로 들어오는 네트워크 트래픽을 원격 서버를 거쳐 목적지 시스템의 특정 포트로 안전하게 전달(터널링)하는 네트워크 보안 기법입니다. 주로 프라이빗 망에 있는 데이터베이스나 내부 시스템에 로컬 PC에서 접근할 때 사용됩니다.

---

Next Step: ALB(Application Load Balancer)를 활용한 퍼블릭/프라이빗 트래픽 분배 아키텍처 구성 / Terragrunt 템플릿(DRY)을 이용한 다중 리전(Multi-Region) 프로비저닝 기법
