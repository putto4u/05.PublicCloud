## ν…λΌνΌ(Terraform) μƒνƒ νμΌμ `serial`κ³Ό `schema_version` λΉ„κµ

ν…λΌνΌ(Terraform)μ μƒνƒ νμΌ(State File)[^1] λ‚΄λ¶€μ—λ” μΈν”„λΌμ ν„μ¬ μƒνƒλ¥Ό κ΄€λ¦¬ν•κ³  λ²„μ „ μ¶©λμ„ λ°©μ§€ν•κΈ° μ„ν• μ¤‘μ”ν• λ©”νƒ€λ°μ΄ν„°(Metadata, λ°μ΄ν„°μ— λ€ν• λ°μ΄ν„°)κ°€ μ΅΄μ¬ν•©λ‹λ‹¤. κ·Έμ¤‘ ν•µμ‹¬ μ μ–΄ μ”μ†μΈ `serial`κ³Ό `schema_version`μ μ—­ν• κ³Ό μ°¨μ΄μ μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

### 1. `serial` (μƒνƒ κ°±μ‹  μΌλ ¨λ²νΈ)

* **κ°λ…**: ν…λΌνΌ μƒνƒ νμΌμ΄ μμ •λκ³  μ„±κ³µμ μΌλ΅ μ €μ¥λ  λ•λ§λ‹¤ 1μ”© μ¦κ°€ν•λ” μ •μ(Integer) κ°’μ…λ‹λ‹¤.
* **μ£Όμ” λ©μ **: **λ™μ‹μ„± μ μ–΄(Concurrency Control)** λ° **μ¤λλ μƒνƒ(Stale State) λ®μ–΄μ“°κΈ° λ°©μ§€**
* **λ™μ‘ μ›λ¦¬**:
* μ‘μ—…μκ°€ `terraform apply` λ…λ Ήμ„ μ‹¤ν–‰ν•μ—¬ μΈν”„λΌλ¥Ό λ³€κ²½ν•λ©΄, ν…λΌνΌμ€ λ³€κ²½ μ‚¬ν•­μ„ μƒνƒ νμΌμ— κΈ°λ΅ν•κ³  `serial` κ°’μ„ κΈ°μ΅΄λ³΄λ‹¤ λ†’κ² κ°±μ‹ ν•©λ‹λ‹¤.
* μ›κ²© μƒνƒ(Remote State) μ €μ¥μ†(μ: Amazon S3[^2])λ¥Ό μ‚¬μ©ν•  λ•, ν„μ¬ λ΅μ»¬(Local)μ—μ„ μ‘μ—… μ¤‘μΈ μƒνƒ νμΌμ `serial` κ°’μ΄ μ›κ²© μ €μ¥μ†μ `serial` κ°’λ³΄λ‹¤ λ‚®λ‹¤λ©΄ ν…λΌνΌμ€ μ‘μ—…μ„ κ±°λ¶€(Reject)ν•©λ‹λ‹¤. μ΄λ” λ‹¤λ¥Έ μ‘μ—…μκ°€ μ΄λ―Έ μΈν”„λΌλ¥Ό λ³€κ²½ν•μ—¬ μ›κ²© μƒνƒκ°€ μ—…λ°μ΄νΈλμ—μμ„ μλ―Έν•λ―€λ΅, μƒνƒ νμΌμ μ¶©λ(Split-brain) ν„μƒμ„ λ°©μ§€ν•©λ‹λ‹¤.



### 2. `schema_version` (μ¤ν‚¤λ§ λ²„μ „)

* **κ°λ…**: ν…λΌνΌ ν”„λ΅λ°”μ΄λ”(Terraform Provider, ν΄λΌμ°λ“ μ„λΉ„μ¤ APIμ™€ μƒνΈ μ‘μ©ν•λ” ν”λ¬κ·ΈμΈ)κ°€ μ •μν• κ°λ³„ λ¦¬μ†μ¤(Resource)μ λ‚΄λ¶€ λ°μ΄ν„° κµ¬μ΅° λ²„μ „μ„ μλ―Έν•©λ‹λ‹¤. (μƒνƒ νμΌ μ „μ²΄μ ν¬λ§· λ²„μ „μ€ μµμƒλ‹¨μ `version` ν‚¤λ΅ λ³„λ„ κ΄€λ¦¬λ©λ‹λ‹¤.)
* **μ£Όμ” λ©μ **: **ν•μ„ νΈν™μ„± μ μ§€(Backward Compatibility)** λ° **μƒνƒ λ§μ΄κ·Έλ μ΄μ…(State Migration)**
* **λ™μ‘ μ›λ¦¬**:
* ν΄λΌμ°λ“ μ„λΉ„μ¤μ κΈ°λ¥μ΄ μ¶”κ°€λμ–΄ ν”„λ΅λ°”μ΄λ”κ°€ μ—…λ°μ΄νΈλλ©΄, νΉμ • λ¦¬μ†μ¤μ μ†μ„±(Attribute)μ΄ μ¶”κ°€λκ±°λ‚ κµ¬μ΅°κ°€ λ³€κ²½λ  μ μμµλ‹λ‹¤. μ΄λ• ν”„λ΅λ°”μ΄λ” κ°λ°μλ” ν•΄λ‹Ή λ¦¬μ†μ¤μ `schema_version`μ„ μ¬λ¦½λ‹λ‹¤.
* ν…λΌνΌμ€ μƒνƒ νμΌμ„ μ½μ„ λ•, κΈ°λ΅λ λ¦¬μ†μ¤μ `schema_version`κ³Ό ν„μ¬ ν”„λ΅μ νΈμ— μ„¤μΉλ ν”„λ΅λ°”μ΄λ”κ°€ μ”κµ¬ν•λ” λ²„μ „μ„ λΉ„κµν•©λ‹λ‹¤. λ²„μ „μ΄ λ‹¤λ¥΄λ‹¤λ©΄, ν”„λ΅λ°”μ΄λ”μ— λ‚΄μ¥λ μƒνƒ λ§μ΄κ·Έλ μ΄μ… λ΅μ§μ„ μ‹¤ν–‰ν•μ—¬ κ³Όκ±° λ²„μ „μ μƒνƒ λ°μ΄ν„°λ¥Ό μµμ‹  κµ¬μ΅°λ΅ μλ™ λ³€ν™(μ—…κ·Έλ μ΄λ“)ν•©λ‹λ‹¤.



### 3. ν•µμ‹¬ μ°¨μ΄μ  μ”μ•½

| κµ¬λ¶„ | `serial` | `schema_version` |
| --- | --- | --- |
| **μ μ© λ²”μ„** | **μƒνƒ νμΌ μ „μ²΄(State File)** | **κ°λ³„ λ¦¬μ†μ¤(Individual Resource)** |
| **λ³€κ²½ μ£Όμ²΄** | ν…λΌνΌ μ½”μ–΄(Terraform Core) | ν…λΌνΌ ν”„λ΅λ°”μ΄λ”(Terraform Provider) |
| **λ³€κ²½ μ‹μ ** | μƒνƒ νμΌμ΄ κ°±μ‹ (`apply`, `refresh`, `import` λ“±)λ  λ•λ§λ‹¤ | ν”„λ΅λ°”μ΄λ” λ‚΄ λ¦¬μ†μ¤μ λ°μ΄ν„° κµ¬μ΅° μ½”λ“κ°€ μ—…λ°μ΄νΈλ  λ• |
| **λ³΄νΈ λ©μ ** | λ‹¤μ¤‘ μ‘μ—… ν™κ²½μ—μ„μ λ™μ‹ μ‘μ—… μ¶©λ λ°©μ§€ λ° λ¬΄κ²°μ„± ν™•λ³΄ | ν”„λ΅λ°”μ΄λ” λ²„μ „ μ—…κ·Έλ μ΄λ“ μ‹ λ¦¬μ†μ¤ λ°μ΄ν„° νΈν™μ„± λ³΄μ¥ |
| **μ—λ¬ λ°μƒ μμ‹** | "State is older than remote state" (μ›κ²© μƒνƒλ³΄λ‹¤ μ¤λλ¨) | "State migration failed" (μƒνƒ λ§μ΄κ·Έλ μ΄μ… μ‹¤ν¨) |

---

### π’΅ μ‹¤μ „ ν λ° μμ£Ό λ°μƒν•λ” μ¤ν•΄(Pitfalls)

* **`serial`μ„ μ„μλ΅ μμ •ν•λ” μ‹¤μ**: μ›κ²© μƒνƒ μ €μ¥μ†μ™€ λ™κΈ°ν™”κ°€ μ–΄κΈ‹λ‚¬μ„ λ•(`serial` μ¶©λ μ—λ¬ λ°μƒ μ‹), λ΅μ»¬ μƒνƒ νμΌμ `serial` μ«μλ¥Ό ν…μ¤νΈ μ—λ””ν„°λ΅ μλ™μΌλ΅ λ†’μ—¬μ„ κ°•μ λ΅ ν‘Έμ‹(Push)ν•λ ¤λ” μ‹λ„λ” **μ λ€ κΈλ¬Ό**μ…λ‹λ‹¤. μ΄λ” μ‹¤μ  μΈν”„λΌ μƒνƒμ™€ ν…λΌνΌμ΄ μΈμ‹ν•λ” μƒνƒ κ°„μ μ‹¬κ°ν• λ¶μΌμΉλ¥Ό μ΄λν•μ—¬ μΈν”„λΌ νκ΄΄λ΅ μ΄μ–΄μ§ μ μμµλ‹λ‹¤. λ°λ“μ‹ `terraform pull` λ…λ Ήμ–΄λ΅ μµμ‹  μ›κ²© μƒνƒλ¥Ό κ°€μ Έμ™€ λ΅μ»¬κ³Ό μ•μ „ν•κ² λ³‘ν•©(Merge)ν•κ±°λ‚ λ³€κ²½ μ›μΈμ„ νμ•…ν•΄μ•Ό ν•©λ‹λ‹¤.
* **ν”„λ΅λ°”μ΄λ” λ‹¤μ΄κ·Έλ μ΄λ“(Downgrade) μ„ν—μ„±**: `schema_version`μ΄ μ΄λ―Έ μƒμ„ λ²„μ „μΌλ΅ λ§μ΄κ·Έλ μ΄μ…λ μƒνƒ νμΌμ€ ν•μ„ λ²„μ „μ ν”„λ΅λ°”μ΄λ”μ—μ„ μ •μƒμ μΌλ΅ μ½μ„ μ μ—†μµλ‹λ‹¤. λ”°λΌμ„ μ΄μ μ¤‘μΈ ν…λΌνΌ ν”„λ΅μ νΈμ—μ„ ν”„λ΅λ°”μ΄λ”μ λ²„μ „μ„ λ‚®μ¶”λ” μ‘μ—…μ€ μƒνƒ νμΌ λ¶„μ„ μ¤λ¥λ¥Ό μ λ°ν•λ―€λ΅, ν”„λ΅λ°”μ΄λ” λ²„μ „ κ³ μ •(Version Pinning)μ„ μ² μ €ν κ΄€λ¦¬ν•΄μ•Ό ν•©λ‹λ‹¤.

---

[^1]: **μƒνƒ νμΌ(State File)**: ν…λΌνΌμ΄ κ΄€λ¦¬ν•λ” μ‹¤μ  ν΄λΌμ°λ“ μΈν”„λΌ λ¦¬μ†μ¤μ™€ μ‚¬μ©μκ°€ μ‘μ„±ν• μ„¤μ • νμΌ(`.tf`) κ°„μ λ§¤ν•‘(Mapping) μ •λ³΄λ¥Ό μ μ΄μ¨(JSON, JavaScript Object Notation: λ°μ΄ν„°λ¥Ό μ €μ¥ν•κ±°λ‚ μ „μ†΅ν•  λ• λ§μ΄ μ‚¬μ©λλ” κ²½λ‰μ ν…μ¤νΈ κΈ°λ° λ°μ΄ν„° κµν™ ν•μ‹) ν•μ‹μΌλ΅ μ €μ¥ν•λ” νμΌ(`terraform.tfstate`)μ…λ‹λ‹¤.
[^2]: **Amazon S3(Amazon Simple Storage Service)**: AWSμ—μ„ μ κ³µν•λ” λ¬΄μ ν• κ°μ²΄ μ¤ν† λ¦¬μ§€(Object Storage) μ„λΉ„μ¤λ΅, ν…λΌνΌμ μ›κ²© μƒνƒ νμΌμ„ μ•μ „ν•κ² λ³΄κ΄€ν•λ” λ°±μ—”λ“(Backend)λ΅ κ°€μ¥ λ„λ¦¬ μ‚¬μ©λ©λ‹λ‹¤. (μ €μ¥ μ©λ‰ λ° μ”μ²­ κ±΄μμ— λ”°λΌ κ³ΌκΈλλ” μ λ£ μ„λΉ„μ¤μ…λ‹λ‹¤.)

Next Step: ν…λΌνΌ μƒνƒ μ κΈ(Terraform State Lock)κ³Ό μ•„λ§μ΅΄ λ‹¤μ΄λ‚λ¨λ””λΉ„(Amazon DynamoDB) μ—°λ™
