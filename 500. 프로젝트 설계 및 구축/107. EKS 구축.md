## 3일차: 고가용성 EKS 클러스터 구축 및 IRSA 기반 보안 설계 (Project: awskr01)

오늘의 목표는 2일차에 구축한 네트워크 인프라 위에 **AWS의 핵심 컨테이너 서비스인 EKS(Elastic Kubernetes Service, 엘라스틱 쿠버네티스 서비스)**를 올리는 것입니다. 단순히 클러스터를 생성하는 것을 넘어, 쿠버네티스 내부의 서비스가 AWS의 다른 자원(S3, ALB 등)에 안전하게 접근할 수 있도록 해주는 **IRSA(IAM Roles for Service Accounts, 서비스 계정을 위한 IAM 역할)** 보안 체계를 설계하고 구축합니다.

---

### 1. 작업 목적 및 주요 내용

* **EKS 클러스터 생성:** AWS 관리형 쿠버네티스 컨트롤 플레인을 구축합니다.
* **관리형 노드 그룹(Managed Node Groups) 구성:** 실제 애플리케이션이 돌아갈 가상 서버(EC2)들을 프라이빗 서브넷에 배치하여 보안을 강화합니다.
* **OIDC(OpenID Connect) 공급자 활성화:** 쿠버네티스 서비스 계정이 AWS IAM 역할을 사용할 수 있도록 하는 인증 다리를 놓습니다. (IRSA의 핵심)
* **보안 그룹 최적화:** 클러스터와 노드 간의 통신을 위한 최소 권한 방화벽 규칙을 적용합니다.

---

### 2. 테라폼 모듈 작성: EKS 및 보안 인증 (IRSA)

**파일 1: `infrastructure/modules/aws-eks/variables.tf**`

```terraform
variable "cluster_name" {
  description = "EKS 클러스터의 고유 명칭"
  type        = string
  default     = "awskr01-spoke-eks"
}

variable "vpc_id" {
  description = "EKS가 배치될 VPC의 ID (네트워크 모듈에서 출력된 값)"
  type        = string
}

variable "private_subnets" {
  description = "워커 노드가 배치될 안전한 프라이빗 서브넷 리스트"
  type        = list(string)
}

variable "instance_types" {
  description = "워커 노드용 EC2 사양 (과금 주의: t3.medium 이상 권장)"
  type        = list(string)
  default     = ["t3.medium"]
}

```

**파일 2: `infrastructure/modules/aws-eks/main.tf**`

```terraform
# AWS 공식 EKS 모듈을 사용하여 복잡한 설정을 표준화합니다.
module "eks" {
  source  = "terraform-aws-modules/eks/aws"
  version = "19.15.3"

  cluster_name    = var.cluster_name
  cluster_version = "1.27" # 쿠버네티스 버전 설정

  # 클러스터 엔드포인트 보안 설정: 관리의 편의를 위해 퍼블릭 액세스를 허용하되, 
  # 실제 워크로드는 프라이빗 서브넷에서만 통신하도록 설계합니다.
  cluster_endpoint_public_access = true

  vpc_id                   = var.vpc_id
  subnet_ids               = var.private_subnets
  control_plane_subnet_ids = var.private_subnets

  # IRSA (IAM Roles for Service Accounts) 기능을 활성화하기 위한 OIDC 공급자 생성
  enable_irsa = true

  # EKS 관리형 노드 그룹 설정 (Auto Scaling Group 자동 관리)
  # [과금 주의] t3.medium 노드 2대 실행 시 시간당 약 $0.116 (EKS 요금 $0.10 별도)
  eks_managed_node_groups = {
    initial = {
      min_size     = 1
      max_size     = 3
      desired_size = 2 # 기본 2대의 노드로 시작하여 고가용성 확보

      instance_types = var.instance_types
      capacity_type  = "ON_DEMAND" # 안정적인 서비스를 위해 온디맨드 방식 사용
    }
  }

  tags = {
    Environment = "dev"
    Project     = "awskr01"
  }
}

```

---

### 3. 테라그런트 설정: 의존성 주입 (Dependency)

EKS는 반드시 네트워크(VPC)가 먼저 생성되어야 하므로, 테라그런트의 `dependency` 기능을 사용하여 네트워크 모듈로부터 정보를 받아옵니다.

**파일 3: `infrastructure/live/020-spokes/ap-northeast-2/eks/terragrunt.hcl**`

```hcl
include {
  path = find_in_parent_folders()
}

terraform {
  source = "../../../../modules/aws-eks"
}

# [핵심] 네트워크 모듈의 출력값(VPC ID, Subnet ID)을 가져오기 위한 의존성 정의
dependency "network" {
  config_path = "../network"
}

inputs = {
  cluster_name    = "awskr01-spoke-eks"
  vpc_id          = dependency.network.outputs.vpc_id
  private_subnets = dependency.network.outputs.private_subnets
  instance_types  = ["t3.medium"]
}

```

---

### 4. 실습 및 배포 절차 (Daily Workflow)

**Step 1: 이전 단계 인프라 복구 (VPC 등)**
EKS는 네트워크 위에서 돌아가므로 반드시 네트워크가 먼저 떠 있어야 합니다.

```bash
cd infrastructure/live/020-spokes/ap-northeast-2/network
terragrunt apply -auto-approve

```

**Step 2: EKS 클러스터 구축 실행**

```bash
cd ../eks
terragrunt init
# [주의] EKS 구축은 약 10~15분 정도 소요됩니다. 
terragrunt apply

```

**Step 3: 구축 결과 확인 (Kubeconfig 업데이트)**
배포가 완료되면 로컬 PC에서 쿠버네티스 명령(`kubectl`)을 내릴 수 있도록 인증 정보를 업데이트합니다.

```bash
# AWS CLI를 사용하여 로컬의 ~/.kube/config 파일에 클러스터 접속 정보 등록
aws eks update-kubeconfig --region ap-northeast-2 --name awskr01-spoke-eks

# 노드 상태 확인 (Ready 상태가 나오면 성공)
kubectl get nodes

```

---

### 5. 작업 종료 및 자원 삭제 (퇴근 절차)

EKS 클러스터와 노드 그룹은 **시간당 고정 비용**이 발생하므로, 작업 종료 후 반드시 삭제해야 합니다.

```bash
# 1. EKS 자원 먼저 삭제 (의존성 역순)
cd infrastructure/live/020-spokes/ap-northeast-2/eks
terragrunt destroy -auto-approve

# 2. 네트워크 자원 삭제 (NAT Gateway 비용 차단)
cd ../network
terragrunt destroy -auto-approve

# 3. 깃허브 코드 백업
cd /d/projects/awskr01
git add .
git commit -m "feat: EKS 클러스터 및 IRSA를 위한 OIDC 공급자 설정 완료"
git push origin main

```

---

### [주석 및 전문 용어 해설]

* **OIDC (OpenID Connect):** 구글이나 카카오 로그인처럼, 외부 시스템(AWS IAM)이 쿠버네티스 내부의 사용자(Service Account)를 믿고 권한을 빌려줄 수 있게 해주는 인증 표준 프로토콜입니다.
* **IRSA (IAM Roles for Service Accounts):** 쿠버네티스의 특정 파드(Pod)에만 특정 AWS 권한(예: S3 읽기)을 부여하는 보안 기술입니다. 노드 전체에 권한을 주는 방식보다 훨씬 안전합니다.
* **Managed Node Groups:** AWS가 EC2 인스턴스의 패치, 업데이트, 교체를 자동으로 관리해 주는 방식입니다.

---

Next Step: AWS Load Balancer Controller 배포 (ALB 연동 및 외부 노출 설정)
