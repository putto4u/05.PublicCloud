# 글로벌 확장을 고려한 단계별 IaC 디렉토리 설계 및 무결점 파이프라인

단일 스포크(Spoke, 네트워크의 말단 노드) 클러스터에서 시작하여 향후 3개 대륙을 연결하는 글로벌 허브 앤 스포크(Hub & Spoke)[^1] 아키텍처로 진화하기 위해서는, 인프라 코드의 디렉토리 구조 자체가 **'작업의 순서(Workflow)'**와 **'미래의 확장성(Scalability)'**을 동시에 표현해야 합니다.

현재는 단일 스포크만 운영하지만, 조만간 한국 리전에 허브(Hub, 네트워크의 중앙 집중점)를 신설하고 네트워크 통제권(NAT Gateway, Bastion Host 등)을 이관해야 합니다. 이를 마이그레이션(Migration, 시스템 이전) 작업에 따른 다운타임(Downtime, 시스템 가동 불가 시간) 없이 수행하기 위해, 사전 작업(IAM, 인증)부터 애플리케이션 배포까지 모든 과정을 코드로 정의하고 작업 순서가 반영된 넘버링(Numbering) 규칙을 부여합니다.

---

### 1. 작업 순서 기반 전체 프로젝트 디렉토리 구조 (Current & Future)

인프라스트럭처의 의존성 흐름에 따라 `000`부터 `040`까지 디렉토리 번호를 부여하여, 실행 순서를 직관적으로 강제합니다.

```text
global-microservices-project/
├── scripts/                               # 방어적 파이프라인 스크립트 모음
│   ├── 01-current-spoke-build.sh          # [현재] 단일 스포크 구축용
│   ├── 02-current-spoke-destroy.sh        # [현재] 단일 스포크 폐기용
│   ├── 03-future-global-build.sh          # [미래] 글로벌 3개 리전 일괄 구축용
│   └── 04-future-global-destroy.sh        # [미래] 글로벌 3개 리전 일괄 폐기용
│
├── infrastructure/                        # Terragrunt 기반 클라우드 인프라 영역
│   ├── modules/                           # [순수 Terraform] 논리적으로 분리된 재사용 템플릿
│   │   ├── aws-network-hub/               # TGW, 중앙 NAT Gateway, 공유 Bastion 등
│   │   ├── aws-network-spoke/             # ★ 핵심: 변수(enable_nat)로 NAT 토글 기능 구현
│   │   ├── aws-eks/
│   │   └── aws-rds/
│   │
│   └── live/                              # [Terragrunt HCL] 실제 환경 배포 정의
│       ├── terragrunt.hcl                 # 전역 설정 (S3 State Bucket 자동 생성 등)
│       │
│       ├── 000-prerequisites/             # [사전 작업] AWS IAM, OIDC, KMC 등 기초 공사
│       │   └── ap-northeast-2/
│       │       ├── iam-roles/terragrunt.hcl
│       │       └── ecr-repos/terragrunt.hcl
│       │
│       ├── 010-hub/                       # [미래 이전 영역] 당장은 비워두지만, 조만간 구축됨
│       │   └── ap-northeast-2/
│       │       ├── network/terragrunt.hcl # 향후 중앙 NAT Gateway가 위치할 곳
│       │       └── tgw/terragrunt.hcl     # 글로벌 통신용 Transit Gateway
│       │
│       └── 020-spokes/                    # [현재 운영 영역] 워크로드 클러스터
│           ├── ap-northeast-2/            # 한국 리전 (현재 단일 스포크)
│           │   ├── network/terragrunt.hcl # 현재: enable_nat=true / 허브 연결 시: false로 변경
│           │   ├── eks/terragrunt.hcl
│           │   └── rds/terragrunt.hcl
│           │
│           ├── us-east-1/                 # [미래 확장] 미국 동부
│           └── eu-west-2/                 # [미래 확장] 영국 런던
│
└── kubernetes/                            # EKS 내부 배포 매니페스트 (YAML)
    ├── 030-k8s-config/                    # [연결 작업] 인프라와 K8s를 연결하는 설정
    │   ├── aws-auth.yaml                  # IAM Role과 K8s RBAC 매핑
    │   └── service-accounts.yaml          # IRSA (IAM Roles for Service Accounts) 연결
    │
    └── 040-k8s-workloads/                 # [워크로드] 실제 서비스 및 애드온
        ├── addons/                        # AWS LBC, External-DNS
        ├── backend/                       # 백엔드 API 서버 (HPA 포함)
        └── frontend/                      # 프론트엔드 웹 서버 (Ingress 포함)

```

---

### 2. 현재 단계 (단일 스포크) 파이프라인 스크립트

현재 구축된 `000` (사전 작업), `020` (한국 스포크), `030`, `040` (쿠버네티스) 디렉토리만 실행하며, 아직 존재하지 않는 `010-hub`나 타 리전 코드는 에러 없이 통과(Bypass)하도록 설계된 방어적 스크립트입니다.

**구축 스크립트: `scripts/01-current-spoke-build.sh**`

```bash
#!/bin/bash
set -e # 에러 발생 시 즉시 중단

echo "=== 1. 사전 인프라(IAM 등) 구성 (000-prerequisites) ==="
if [ -d "../infrastructure/live/000-prerequisites" ]; then
    cd ../infrastructure/live/000-prerequisites
    terragrunt run-all apply --terragrunt-non-interactive
    cd - > /dev/null
fi

# 010-hub는 현재 비어있거나 없으므로 검사 후 안전하게 통과
echo "=== 2. 허브 인프라 구성 (010-hub) - 현재 생략 ==="

echo "=== 3. 단일 스포크 인프라 구성 (020-spokes/ap-northeast-2) ==="
# 과금 주의: NAT Gateway(시간당 $0.045), EKS(시간당 $0.10), RDS 과금 시작
if [ -d "../infrastructure/live/020-spokes/ap-northeast-2" ]; then
    cd ../infrastructure/live/020-spokes/ap-northeast-2
    terragrunt run-all apply --terragrunt-non-interactive
    cd - > /dev/null
fi

echo "=== 4. EKS 자격 증명 및 쿠버네티스 연결 (030-k8s-config) ==="
if aws eks describe-cluster --region ap-northeast-2 --name globalapp-spoke-eks > /dev/null 2>&1; then
    aws eks update-kubeconfig --region ap-northeast-2 --name globalapp-spoke-eks
    [ -d "../kubernetes/030-k8s-config" ] && kubectl apply -f ../kubernetes/030-k8s-config/
fi

echo "=== 5. 마이크로서비스 배포 (040-k8s-workloads) ==="
# 과금 주의: ALB(로드 밸런서 용량 단위) 과금 시작
if [ -d "../kubernetes/040-k8s-workloads" ]; then
    [ -d "../kubernetes/040-k8s-workloads/addons" ] && kubectl apply -f ../kubernetes/040-k8s-workloads/addons/
    sleep 15
    [ -d "../kubernetes/040-k8s-workloads/backend" ] && kubectl apply -f ../kubernetes/040-k8s-workloads/backend/
    [ -d "../kubernetes/040-k8s-workloads/frontend" ] && kubectl apply -f ../kubernetes/040-k8s-workloads/frontend/
fi
echo "✅ 현재 단계 단일 스포크 구축 완료"

```

**폐기 스크립트: `scripts/02-current-spoke-destroy.sh**`

```bash
#!/bin/bash
set -e

echo "=== 1. 쿠버네티스 워크로드 회수 (040 -> 030 역순) ==="
aws eks update-kubeconfig --region ap-northeast-2 --name globalapp-spoke-eks || true
if [ -d "../kubernetes/040-k8s-workloads" ]; then
    kubectl delete -f ../kubernetes/040-k8s-workloads/frontend/ --ignore-not-found=true || true
    kubectl delete -f ../kubernetes/040-k8s-workloads/backend/ --ignore-not-found=true || true
    kubectl delete -f ../kubernetes/040-k8s-workloads/addons/ --ignore-not-found=true || true
    echo "AWS 리소스(ALB 등) 삭제 대기 (90초)..."
    sleep 90
fi

echo "=== 2. 단일 스포크 인프라 회수 (020-spokes/ap-northeast-2) ==="
if [ -d "../infrastructure/live/020-spokes/ap-northeast-2" ]; then
    cd ../infrastructure/live/020-spokes/ap-northeast-2
    terragrunt run-all destroy --terragrunt-non-interactive
    cd - > /dev/null
fi

echo "=== 3. 사전 인프라 회수 (000-prerequisites) ==="
if [ -d "../infrastructure/live/000-prerequisites" ]; then
    cd ../infrastructure/live/000-prerequisites
    terragrunt run-all destroy --terragrunt-non-interactive
    cd - > /dev/null
fi
echo "✅ 현재 단계 단일 스포크 폐기 완료 (과금 중단)"

```

---

### 3. 향후 단계 (글로벌 3개 리전 허브 앤 스포크) 파이프라인 스크립트

조만간 한국 리전에 허브(010-hub)를 구축하고, 이어서 3개 대륙의 스포크를 한 번에 찍어낼 때 사용할 미래형 스크립트입니다. `terragrunt run-all`의 강력한 동시성을 활용합니다.

**글로벌 구축 스크립트: `scripts/03-future-global-build.sh**`

```bash
#!/bin/bash
set -e

# 000 사전작업 (IAM 등) 일괄 배포
[ -d "../infrastructure/live/000-prerequisites" ] && cd ../infrastructure/live/000-prerequisites && terragrunt run-all apply --terragrunt-non-interactive && cd - > /dev/null

# 010 글로벌 허브 통신망 배포 (TGW 등)
# 과금 주의: TGW (시간당 $0.05 및 데이터 요금) 과금 시작
echo "=== 글로벌 통신 허브망 구축 ==="
[ -d "../infrastructure/live/010-hub" ] && cd ../infrastructure/live/010-hub && terragrunt run-all apply --terragrunt-non-interactive && cd - > /dev/null

# 020 전 세계 스포크 동시 배포 (한국, 미국, 영국 병렬 처리)
# 과금 주의: 각 리전별 EKS, RDS 3배수 과금
echo "=== 3개 리전 스포크 워크로드 동시 구축 ==="
[ -d "../infrastructure/live/020-spokes" ] && cd ../infrastructure/live/020-spokes && terragrunt run-all apply --terragrunt-non-interactive && cd - > /dev/null

# 이후 리전별 루프(Loop)를 돌며 K8s 030, 040 배포하는 로직 추가 (지면상 생략)
echo "✅ 글로벌 허브 앤 스포크 인프라 배포 완료"

```

---

### 4. 핵심 아키텍처 원리: 조만간 실행될 허브(Hub) 마이그레이션 전략

현재 `020-spokes/ap-northeast-2/network` 안에는 스포크 자체가 외부와 통신하기 위해 임시로 만들어진 NAT Gateway가 동작하고 있습니다. 향후 `010-hub` 디렉토리에 허브망을 구축한 후, 스포크를 허브로 종속시킬 때 코드는 다음과 같이 단 한 줄만 변경됩니다.

1. `020-spokes/ap-northeast-2/network/terragrunt.hcl` 파일을 엽니다.
2. 입력 변수를 `inputs = { enable_nat = true }`에서 `inputs = { enable_nat = false, tgw_id = "tgw-xxxxx" }`로 수정합니다.
3. 파이프라인을 재실행합니다.
4. **결과:** 인프라 파괴 없이, 기존 스포크에 있던 NAT Gateway만 깔끔하게 삭제되며, 통신 라우팅 테이블이 허브의 TGW를 바라보게 됩니다. 이것이 디렉토리를 미리 쪼개놓고 변수로 제어하는 진정한 **마이그레이션 제로(Zero-Migration)** 설계입니다.

---

**[주석]**

* [^1] **Hub & Spoke (허브 앤 스포크):** 자전거 바퀴의 중심축(Hub)과 바퀴살(Spoke)에서 유래한 네트워크 설계 패턴. 중앙의 Hub VPC를 통해 모든 통신이 통제되며, Spoke VPC들은 Hub를 거쳐 서로 통신하거나 외부로 나갑니다. 네트워크 보안 관리와 확장에 매우 유리합니다.

Next Step: 000-prerequisites 디렉토리 구성 (IAM OIDC 통합 및 S3 State Backend 구축 코드 작성)
