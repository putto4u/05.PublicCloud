# 미래 확장을 대비한 사전 분리(Pre-Separation) 아키텍처 및 마이그레이션 제로(Zero-Migration) 설계

단일 클러스터(Spoke) 환경에서 시작하여 향후 글로벌 허브 앤 스포크(Hub & Spoke)로 진화하는 아키텍처에서 가장 피해야 할 안티 패턴(Anti-Pattern)은 **"초기 구축 시 공통 자원과 개별 자원을 하나의 상태 파일(State File)이나 네트워크 망에 섞어버리는 것"**입니다. 이를 분리하지 않으면 향후 허브(Hub)를 도입할 때 기존 스포크(Spoke)의 네트워크 전체를 허물고 다시 지어야 하는 대형 마이그레이션(Migration) 작업이 발생하며, 이 과정에서 EKS(Elastic Kubernetes Service, 엘라스틱 쿠버네티스 서비스)와 RDS(Relational Database Service, 관계형 데이터베이스 서비스)의 심각한 다운타임(Downtime, 시스템 가동 불가 시간)이 동반됩니다.

따라서 현재 단일 스포크만 구축하더라도, 코드는 이미 허브의 존재를 가정하고 **논리적으로 완벽히 격리된 구조(Decoupled Structure)**를 가져야 합니다. [AWS 다중 계정 및 네트워크 확장 가이드](https://aws.amazon.com/ko/architecture/well-architected/)(출처: Amazon Web Services)를 기반으로, 향후 인프라 파괴 없이 허브를 주입할 수 있는 최적화된 설계를 분석합니다.

---

### 1. 허브(Hub)와 스포크(Spoke) 자원의 명확한 사전 분리 기준

현재 구축하는 코드는 하나지만, 내부적으로 다음의 자원들은 철저히 분리된 모듈(Module)과 디렉토리로 구성되어야 향후 이전(Migration) 작업 자체가 사라집니다.

| 자원 유형 | 향후 위치 | 사전 분리 설계 (현재 코딩 방식) | 향후 확장 시나리오 (Migration-Free) |
| --- | --- | --- | --- |
| **TGW (트랜짓 게이트웨이)** | Hub | 현재는 `live/hub/` 디렉토리만 비워둠 | 추후 해당 디렉토리에 코드만 추가하여 배포 |
| **공유 Bastion (배스천 호스트)** | Hub | 스포크 내부가 아닌 퍼블릭 전용 서브넷 모듈로 분리 | 추후 스포크 내의 Bastion을 삭제하고 Hub에 신규 생성 |
| **NAT Gateway (NAT 게이트웨이)** | Hub (권장) | 스포크 네트워크 모듈 내에 `enable_nat = true` 변수 처리 | 향후 Hub로 중앙화할 때 `false`로 변경하여 스포크의 NAT만 파괴 |
| **EKS 및 RDS (워크로드)** | Spoke | 네트워크 모듈과 분리하여 `dependency` 블록으로만 연결 | **네트워크 라우팅만 변경되므로 자원 파괴 없이 그대로 유지됨** |

---

### 2. 마이그레이션 제로(Zero-Migration)를 위한 Terragrunt 디렉토리 재구성

현재 단일 스포크만 배포하더라도, 디렉토리 트리는 이미 글로벌 확장을 대비한 형태를 취해야 합니다.

```text
global-microservices-project/
├── infrastructure/
│   ├── modules/
│   │   ├── aws-network/            # ★ 핵심: NAT GW 생성 여부를 변수로 제어 가능하게 설계
│   │   ├── aws-eks/
│   │   ├── aws-rds/
│   │   └── aws-tgw/                # 모듈은 미리 만들어 둠
│   │
│   └── live/
│       ├── terragrunt.hcl
│       │
│       ├── hub/                    # [현재 단계: 디렉토리만 존재, 배포 X]
│       │   └── ap-northeast-2/     
│       │       └── tgw/            # 향후 TGW 코드가 들어갈 자리
│       │
│       └── spokes/                 
│           └── ap-northeast-2/     # [현재 단계: 실제 배포되는 단일 스포크]
│               ├── network/
│               │   └── terragrunt.hcl  # 현재는 inputs = { enable_nat = true } 로 설정
│               ├── eks/
│               └── rds/

```

---

### 3. 향후 허브 앤 스포크(Hub & Spoke) 전환 시나리오 (작동 원리)

위와 같이 사전 분리된 구조에서는, 추후 미국(US)과 영국(UK) 리전을 추가하고 허브를 구성할 때 애플리케이션의 재배포나 DB 백업/복원 과정이 필요 없습니다. 전환 작업은 오직 **라우팅 테이블(Routing Table)의 업데이트**만으로 끝납니다.

**전환 프로세스 (Day 2 Operations):**

1. **Hub 프로비저닝:** `live/hub/ap-northeast-2/tgw/`에 코드를 작성하고 TGW를 생성합니다.
2. **Spoke 네트워크 업데이트:** 기존 `live/spokes/ap-northeast-2/network/terragrunt.hcl` 파일을 열고 다음과 같이 변수를 수정합니다.
* `enable_nat = false` (기존 Spoke의 독립적인 인터넷 출구를 닫음)
* `tgw_id = "tgw-xxxxxxx"` (새로 만든 Hub의 TGW ID를 주입)


3. **Terragrunt Apply 실행:** Terragrunt는 Spoke의 NAT Gateway를 삭제하여 과금을 줄이고, 라우팅 테이블의 `0.0.0.0/0` (인터넷 트래픽) 경로를 TGW를 향하도록 부드럽게(Gracefully) 변경합니다.
4. **결과:** EKS 클러스터와 RDS는 이 네트워크 변경을 전혀 눈치채지 못한 채(무중단) 허브를 통해 전 세계 리전과 통신하게 됩니다.

> ⚠️ **AWS 과금 주의 및 최적화:**
> 단일 스포크일 때는 Spoke VPC 자체에 NAT Gateway(네트워크 주소 변환 게이트웨이)가 있어야 외부 통신이 가능하므로 **시간당 약 $0.045의 요금**이 발생합니다. 하지만 향후 Hub를 만들고 중앙 집중형 송신(Centralized Egress)[^1] 구조로 전환하면, 전 세계의 Spoke VPC들은 NAT를 가지지 않고 하나의 Hub NAT를 공유하므로 **전체 아키텍처의 네트워크 유지 비용이 획기적으로 절감**됩니다.

---

### 💡 실전 팁 및 자주 오해하거나 실수하는 부분

**💡 자주 오해하는 부분: "VPC를 합치면 안 되나요?"**
"어차피 나중에 하나로 묶을 거라면, 처음부터 엄청나게 큰 VPC를 하나 만들어서 EKS, TGW, 중앙 DB를 다 때려 넣으면 관리가 편하지 않을까?"라는 생각은 주니어 엔지니어들이 가장 많이 하는 오해입니다. 인프라의 폭발 반경(Blast Radius)[^2]을 줄이고 규정 준수(Compliance)를 지키기 위해, 네트워크망(VPC)은 반드시 역할(Hub/Spoke)에 따라 물리적으로 쪼개고 나중에 TGW로 이어붙이는 것이 글로벌 클라우드 표준입니다.

**💡 실전 팁: 의존성(Dependency) 결합도의 분리**
EKS 모듈이 Network 모듈의 `vpc_id`와 `subnet_ids`를 참조할 때, Terragrunt의 `dependency` 블록을 사용합니다. 네트워크 모듈에서 라우팅 테이블이 변경되더라도 `vpc_id` 자체는 변하지 않으므로, Terragrunt는 EKS 모듈이 재배포될 필요가 없다고 스마트하게 판단하여 인프라를 보호합니다. 이것이 코드를 모듈로 완벽히 쪼개야 하는 가장 큰 이유입니다.

---

**[주석]**

* [^1] **Centralized Egress (중앙 집중형 송신):** 각 Spoke VPC마다 인터넷으로 나가는 출구(NAT Gateway)를 두지 않고, 모든 아웃바운드 트래픽을 Hub VPC로 모아서 단일 방화벽과 NAT Gateway를 통해 인터넷으로 내보내는 강력한 보안 및 비용 절감 아키텍처입니다.
* [^2] **Blast Radius (폭발 반경):** 시스템의 특정 부분에 장애가 발생하거나 해킹이 일어났을 때, 그 피해가 미치는 최대 범위를 의미합니다. 아키텍트는 항상 이 반경을 최소화하도록 망을 분리 설계해야 합니다.

---

Next Step: Terraform Network 모듈 내 NAT Gateway 변수 처리(`enable_nat`) 및 동적 라우팅 테이블(Dynamic Routing Table) 구현 코드 작성

---

*(개인적인 메모: 역시 아키텍트답게 아주 예리한 포인트를 짚어주셨습니다. 나중에 허브를 주입할 때 네트워크 구조를 허물게 되면 실무에서는 대형 사고로 이어지죠. 이를 방지하기 위해 단일 스포크 배포 시점부터 모듈의 변수(`enable_nat`)를 조작하여 향후 마이그레이션을 제로(0)로 만드는 진정한 IaC 설계 방식으로 뼈대를 다시 잡고 교재에 반영했습니다. 학생들에게 아키텍처의 '유연성'을 가르치기에 완벽한 흐름이 될 것입니다.)*
