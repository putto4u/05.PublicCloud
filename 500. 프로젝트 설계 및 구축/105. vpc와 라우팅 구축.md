## 2일차: 온프레미스 중심 글로벌 네트워크 설계 및 하이브리드 대응 구축 (Project: awskr01)

오늘의 목표는 온프레미스 대역(**10.10.0.0/16**)을 기준으로 AWS 글로벌 인프라 대역을 **10.20.0.0/16(한국)**, **10.30.0.0/16(미국)**, **10.40.0.0/16(유럽)**으로 각각 할당하고, 데이터베이스 이전을 대비한 보안 구조를 한국 리전 스포크에 반영하는 것입니다.

---

### 1. 글로벌 IP 할당 및 서브넷 분할 전략

전 세계 어디에서 접속하더라도 IP 충돌 없이 통신할 수 있도록 대륙별로 10단위씩 대역을 분리합니다.

| 위치 (Role) | 리전 코드 | 전체 네트워크 대역 (CIDR) | 비고 |
| --- | --- | --- | --- |
| **온프레미스 (On-prem)** | **IDC** | **10.10.0.0/16** | **(기준)** 현재 사무실 및 IDC 대역 |
| **한국 리전 (apne2)** | **ap-northeast-2** | **10.20.0.0/16** | 글로벌 허브 및 첫 번째 스포크 |
| **미국 리전 (use1)** | **us-east-1** | **10.30.0.0/16** | 향후 확장 예정인 미국 동부 스포크 |
| **유럽 리전 (euw2)** | **eu-west-2** | **10.40.0.0/16** | 향후 확장 예정인 영국 런던 스포크 |

#### [세부 설계] 한국 리전 스포크 내부 서브넷 (10.20.0.0/16)

| 서브넷 용도 | 가용 영역(AZ) A | 가용 영역(AZ) C | 비고 |
| --- | --- | --- | --- |
| **Public** | 10.20.1.0/24 | 10.20.2.0/24 | ALB, NAT Gateway 위치 |
| **Private EKS** | 10.20.10.0/24 | 10.20.11.0/24 | 워커 노드 및 애플리케이션 Pod |
| **Private DB** | **10.20.100.0/24** | **10.20.101.0/24** | RDS 및 온프레미스 복제용 |

---


### 2. 모듈 작성: 하이브리드 대응형 스포크 네트워크 (Terraform)

**파일 1: `infrastructure/modules/aws-network-spoke/variables.tf**`
온프레미스(10.10) 대역과의 충돌을 방지하고 글로벌 확장을 고려하여 각 서브넷 대역을 정의합니다.

```terraform
# 1. VPC 전체 대역 설정 (한국 10.20, 미국 10.30, 유럽 10.40)
variable "vpc_cidr" {
  description = "VPC의 IP 대역"
  type        = string
  default     = "10.20.0.0/16" # 현재 실습 중인 한국 리전 대역
}

# 2. NAT 생성 여부 (단독 구축 시 true, 나중에 허브 연결 시 false로 변경)
variable "enable_nat" {
  description = "NAT Gateway 활성화 스위치"
  type        = bool
  default     = true #
}

# 3. 온프레미스 IDC 대역 (이미 예약된 10.10 대역)
variable "onprem_cidr" {
  description = "기존 온프레미스 IDC 네트워크 대역"
  type        = string
  default     = "10.10.0.0/16" #
}

# 4. 퍼블릭 서브넷 (외부 통신용 로드밸런서와 NAT가 위치함)
variable "public_subnets" {
  type        = list(string)
  default     = ["10.20.1.0/24", "10.20.2.0/24"] #
}

# 5. 프라이빗 서브넷 (EKS 워커 노드가 안전하게 위치함)
variable "private_subnets" {
  type        = list(string)
  default     = ["10.20.10.0/24", "10.20.11.0/24"] #
}

# 6. 데이터베이스 서브넷 (RDS가 위치하며 온프레미스 충돌을 피해 100번대 사용)
variable "database_subnets" {
  type        = list(string)
  default     = ["10.20.100.0/24", "10.20.101.0/24"] #
}

```

**파일 2: `infrastructure/modules/aws-network-spoke/main.tf**`
DB 이전을 고려한 보안 그룹(`db_migration_sg`)과 표준 VPC 로직을 구성합니다.

```terraform
# AWS 공식 VPC 모듈 호출 (검증된 코드로 네트워크 자동 구축)
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = "awskr01-spoke-vpc"
  cidr = var.vpc_cidr

  azs              = ["ap-northeast-2a", "ap-northeast-2c"] # 가용 영역 설정
  public_subnets   = var.public_subnets
  private_subnets  = var.private_subnets
  database_subnets = var.database_subnets

  # DB 전용 서브넷 그룹 생성 (RDS 구축 시 필수)
  create_database_subnet_group = true

  # NAT Gateway 설정 (인터넷 통신 경로 확보)
  enable_nat_gateway = var.enable_nat
  single_nat_gateway = true # 비용 절감을 위해 하나만 생성

  tags = { Project = "awskr01", Terraform = "true", Environment = "spoke" }
}

# 온프레미스(10.10.x.x)로의 DB 이관을 위한 하이브리드 전용 보안 그룹
resource "aws_security_group" "db_migration_sg" {
  name        = "awskr01-db-migration-sg"
  description = "Allow DB replication traffic from On-premises"
  vpc_id      = module.vpc.vpc_id # 생성된 VPC에 소속

  # 온프레미스 IDC 대역(10.10)에서 오는 DB(3306) 트래픽만 허용
  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [var.onprem_cidr] # 예약된 IDC 대역 참조
    description = "Allow replication traffic from IDC"
  }

  # 외부로 나가는 모든 트래픽 허용
  egress {
    from_port = 0; to_port = 0; protocol = "-1"; cidr_blocks = ["0.0.0.0/0"]
  }
}

```

---

### 3. 배포 설정: 한국 리전 스포크 실행 파일 (Terragrunt)

**파일 3: `infrastructure/live/020-spokes/ap-northeast-2/network/terragrunt.hcl**`

```hcl
# 최상위 terragrunt.hcl(S3/DynamoDB 설정) 상속
include { path = find_in_parent_folders() }

# 실행할 테라폼 모듈 위치 지정
terraform {
  source = "../../../../modules/aws-network-spoke"
}

# 실제 AWS에 적용할 구체적인 값들 주입
inputs = {
  vpc_cidr         = "10.20.0.0/16"
  onprem_cidr      = "10.10.0.0/16"
  enable_nat       = true # 현재는 허브가 없으므로 직접 인터넷 연결 필요
  public_subnets   = ["10.20.1.0/24", "10.20.2.0/24"]
  private_subnets  = ["10.20.10.0/24", "10.20.11.0/24"]
  database_subnets = ["10.20.100.0/24", "10.20.101.0/24"]
}

```

---

### 4. 2일차 실행 및 확인 방법 (Daily Workflow)

**Step 1: 1일차 인프라 복구 (사전 권한 등)**

```bash
cd /d/projects/awskr01/infrastructure/live/000-prepare/ap-northeast-2
terragrunt apply -auto-approve

```

**Step 2: 신규 네트워크 구축**

```bash
cd ../../../020-spokes/ap-northeast-2/network
terragrunt init   # 초기화 (최초 1회만 수행)
terragrunt apply  # 실제 반영

```

---

### 5. 일일 작업 종료 및 과금 방지 (퇴근 절차)

```bash
# 1. 자원 폐기 (NAT Gateway 등 유료 자원 즉시 삭제)
terragrunt destroy -auto-approve
cd ../../../000-prepare/ap-northeast-2
terragrunt destroy -auto-approve

# 2. 코드 저장 (오늘 작성한 설계를 GitHub에 푸시)
cd /d/projects/awskr01
git add .
git commit -m "feat: 글로벌 3개 대륙 네트워크 설계 및 DB 하이브리드 보안그룹 반영"
git push origin main

```

---

**Next Step: EKS-Cluster-Module-구성-및-IRSA-설정**
