## 2일차: 단일 스포크(Spoke) VPC 네트워크 구축 및 동적 라우팅 설계 (Project: awskr01)

1일차에는 사전 작업(IAM, ECR 등)을 완료했습니다. 2일차의 목표는 실제 워크로드가 실행될 **스포크(Spoke) 네트워크**를 구축하는 것입니다. 이 네트워크는 향후 허브(Hub, 네트워크 중앙 집중점) 망에 연결될 것을 대비하여, **NAT Gateway(NAT 게이트웨이, 네트워크 주소 변환 게이트웨이)**의 생성 여부를 변수 하나로 제어할 수 있는 유연한 구조로 설계합니다.

---

### 1. 2일차 작업 디렉토리 구조 (추가분)

오늘 작업할 내용은 크게 두 곳입니다. 실제 로직을 담은 **모듈**과, 이를 실행할 **환경 설정** 디렉토리를 생성합니다.

```text
awskr01/
├── infrastructure/
│   ├── modules/
│   │   └── aws-network-spoke/           # [신규] 스포크 전용 네트워크 모듈
│   │       ├── main.tf
│   │       ├── variables.tf
│   │       └── outputs.tf
│   │
│   └── live/
│       └── 020-spokes/                  # [신규] 리전별 스포크 배포 정의
│           └── ap-northeast-2/
│               └── network/
│                   └── terragrunt.hcl  # 실행 설정 파일

```

---

### 2. 모듈 작성: 스포크 네트워크 설계도 (Terraform)

**파일 1: `infrastructure/modules/aws-network-spoke/variables.tf**`
한국 리전(Hub) 서브넷 분할 전략(10.10.0.0/16)에 맞춰 기본값을 설정하고, 마이그레이션을 위한 제어 변수를 포함합니다.

```terraform
# VPC 전체 대역 설정
variable "vpc_cidr" {
  description = "VPC의 IP 대역"
  type        = string
  default     = "10.10.0.0/16" # 한국 리전 계획안 반영
}

# 마이그레이션 핵심 스위치
variable "enable_nat" {
  description = "NAT Gateway 생성 여부 (현재는 단독 통신을 위해 true, 향후 허브 연결 시 false로 변경)"
  type        = bool
  default     = true #
}

# 퍼블릭 서브넷 (ALB, NAT Gateway 위치)
variable "public_subnets" {
  description = "퍼블릭 서브넷 대역 리스트"
  type        = list(string)
  default     = ["10.10.1.0/24", "10.10.2.0/24"] # 계획안 반영
}

# 프라이빗 서브넷 (EKS 워커 노드 및 앱 Pod)
variable "private_subnets" {
  description = "EKS 전용 프라이빗 서브넷 대역 리스트"
  type        = list(string)
  default     = ["10.10.10.0/24", "10.10.11.0/24"] # 계획안 반영
}

# 프라이빗 서브넷 (RDS Master 및 Read Replica)
variable "database_subnets" {
  description = "RDS 전용 프라이빗 서브넷 대역 리스트"
  type        = list(string)
  default     = ["10.10.20.0/24", "10.10.21.0/24"] # 계획안 반영
}

```

**파일 2: `infrastructure/modules/aws-network-spoke/main.tf**`
실제 리소스를 생성하는 핵심 로직입니다. 테라폼 공식 모듈을 활용하여 가독성과 생산성을 높입니다.

```terraform
# AWS 공식 VPC 모듈을 사용하여 표준화된 네트워크 구축
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = "awskr01-spoke-vpc"
  cidr = var.vpc_cidr

  azs              = ["ap-northeast-2a", "ap-northeast-2c"]
  public_subnets   = var.public_subnets
  private_subnets  = var.private_subnets
  database_subnets = var.database_subnets # DB 서브넷 계획 반영

  # RDS 사용을 위한 서브넷 그룹 자동 생성
  create_database_subnet_group = true

  # 핵심: enable_nat 변수에 따라 NAT Gateway 생성 여부가 결정됨
  # 과금 주의: NAT Gateway는 개당 시간당 약 $0.045의 비용이 발생합니다.
  enable_nat_gateway = var.enable_nat
  single_nat_gateway = true # 비용 절감을 위해 하나의 NAT Gateway만 생성

  enable_vpn_gateway = false

  tags = {
    Project     = "awskr01"
    Terraform   = "true"
    Environment = "spoke"
  }
}

```

---

### 3. 배포 설정: 한국 리전 스포크 실행 파일 (Terragrunt)

**파일 3: `infrastructure/live/020-spokes/ap-northeast-2/network/terragrunt.hcl**`
최상위 설정을 상속받고, 모듈에 계획된 서브넷 대역을 명시적으로 주입합니다.

```hcl
include {
  path = find_in_parent_folders()
}

terraform {
  source = "../../../../modules/aws-network-spoke"
}

inputs = {
  vpc_cidr         = "10.10.0.0/16"
  enable_nat       = true  # 현재는 단일 스포크이므로 인터넷 통신을 위해 true
  public_subnets   = ["10.10.1.0/24", "10.10.2.0/24"]
  private_subnets  = ["10.10.10.0/24", "10.10.11.0/24"]
  database_subnets = ["10.10.20.0/24", "10.10.21.0/24"] # 계획안의 모든 대역 반영
}

```

---

### 4. 2일차 실행 및 확인 방법 (Daily Workflow)

**Step 1: 어제 작업 복구 (1일차 인프라 살리기)**

```bash
# 000-prepare 디렉토리로 이동 후 복구
cd /d/projects/awskr01/infrastructure/live/000-prepare/ap-northeast-2
terragrunt apply -auto-approve

```

**Step 2: 신규 네트워크 구축 (2일차 작업)**

```bash
# 오늘 생성한 network 디렉토리로 이동
cd ../../../020-spokes/ap-northeast-2/network

# 초기화 및 배포 (S3 백엔드 및 플러그인 설정 포함)
terragrunt init
terragrunt apply

```

**Step 3: 생성 확인 (AWS 콘솔)**

1. **VPC 서비스:** `awskr01-spoke-vpc` (10.10.0.0/16)가 생성되었는지 확인합니다.
2. **서브넷:** 퍼블릭 2개, EKS용 프라이빗 2개, DB용 프라이빗 2개가 정확한 대역으로 생성되었는지 확인합니다.
3. **NAT 게이트웨이:** 퍼블릭 서브넷에 1개의 NAT Gateway가 `Available` 상태인지 확인합니다.

---

### 5. 일일 작업 종료 및 과금 방지 (퇴근 절차)

오늘의 학습이 끝났다면 반드시 역순으로 자원을 삭제하여 불필요한 비용(특히 NAT Gateway 시간당 요금)을 차단하고 코드를 저장합니다.

```bash
# 1. 오늘 작업한 네트워크 삭제 (NAT Gateway 및 VPC 자원 폐기)
terragrunt destroy -auto-approve

# 2. 1일차 작업 내용도 삭제 (ECR, IAM 등)
cd ../../../000-prepare/ap-northeast-2
terragrunt destroy -auto-approve

# 3. 코드 저장 (GitHub 원격 저장소 업로드)
cd /d/projects/awskr01
git add .
git commit -m "feat: 한국 리전 서브넷 전략(10.10.x.x) 기반 스포크 네트워크 구축 완료"
git push origin main

```

---

Next Step: EKS-Cluster-Module-구성-및-IRSA-설정
