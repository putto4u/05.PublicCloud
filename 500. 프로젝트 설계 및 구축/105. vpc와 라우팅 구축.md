

## 2ì¼ì°¨: í•˜ì´ë¸Œë¦¬ë“œ ëŒ€ë¹„í˜• ìŠ¤í¬í¬(Spoke) VPC êµ¬ì¶• ë° DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì•„í‚¤í…ì²˜ ì„¤ê³„

1ì¼ì°¨ì—ëŠ” IAMê³¼ ECR ë“± ì‚¬ì „ í™˜ê²½ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤. 2ì¼ì°¨ì˜ ëª©í‘œëŠ” ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ êµ¬ë™ë  **ìŠ¤í¬í¬(Spoke) ë„¤íŠ¸ì›Œí¬**ë¥¼ êµ¬ì¶•í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. íŠ¹íˆ ì´ë²ˆ ì„¤ê³„ëŠ” í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ **ì˜¨í”„ë ˆë¯¸ìŠ¤(On-premises, ì‚¬ë‚´ êµ¬ì¶•í˜• ì „ì‚°ì‹¤)**ë¡œ ì´ì „í•˜ê±°ë‚˜ í•˜ì´ë¸Œë¦¬ë“œ í™˜ê²½ìœ¼ë¡œ í™•ì¥í•  ê°€ëŠ¥ì„±ì„ ì—¼ë‘ì— ë‘” **'ë§ˆì´ê·¸ë ˆì´ì…˜ ìœ ì—°ì„±'** í™•ë³´ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤.

---

### 1. ë„¤íŠ¸ì›Œí¬ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ êµ¬ì¡°

ë³¸ êµì¬ì—ì„œëŠ” ë‹¨ìˆœí•œ í´ë¼ìš°ë“œ ë°°í¬ë¥¼ ë„˜ì–´, ê¸°ì—…ì˜ ì¸í”„ë¼ ì „ëµ ë³€í™”ì— ì¦‰ê° ëŒ€ì‘í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ í•™ìŠµí•©ë‹ˆë‹¤.

* **ë™ì  NAT ì œì–´**: ë³€ìˆ˜ í•˜ë‚˜ë¡œ **NAT Gateway(Network Address Translation Gateway, ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œ ë³€í™˜ ê²Œì´íŠ¸ì›¨ì´)** ìƒì„±ì„ ì¡°ì ˆí•˜ì—¬ ë¹„ìš©ê³¼ í†µì‹  ê²½ë¡œë¥¼ ìµœì í™”í•©ë‹ˆë‹¤.
* **ë³´ì•ˆ ê·¸ë£¹(Security Group) ì¶”ìƒí™”**: ì˜¨í”„ë ˆë¯¸ìŠ¤ IDC(Internet Data Center)ì™€ì˜ ë°ì´í„° ë³µì œ(Replication)ë¥¼ ìœ„í•œ ì „ìš© í†µë¡œë¥¼ ë¯¸ë¦¬ ì„¤ê³„í•©ë‹ˆë‹¤.
* **ì—”ë“œí¬ì¸íŠ¸ ë…ë¦½ì„±**: ì„œë¹„ìŠ¤ ì˜ì¡´ì„±ì„ ë‚®ì¶”ê¸° ìœ„í•´ ì§ì ‘ì ì¸ ì£¼ì†Œ ëŒ€ì‹  ê°€ìƒ ë„ë©”ì¸ ê¸°ë°˜ì˜ ì ‘ê·¼ ë°©ì‹ì„ ê³ ë ¤í•©ë‹ˆë‹¤.

---

### 2. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```text
awskr01/
â”œâ”€â”€ infrastructure/
â”‚Â  Â â”œâ”€â”€ modules/
â”‚Â  Â â”‚Â  Â â””â”€â”€ aws-network-spoke/           # [ëª¨ë“ˆ] ìŠ¤í¬í¬ ë„¤íŠ¸ì›Œí¬ ë° ë³´ì•ˆ ì„¤ê³„
â”‚Â  Â â”‚Â  Â  Â  Â â”œâ”€â”€ main.tf
â”‚Â  Â â”‚Â  Â  Â  Â â”œâ”€â”€ variables.tf
â”‚Â  Â â”‚Â  Â  Â  Â â””â”€â”€ outputs.tf
â”‚Â  Â â”‚
â”‚Â  Â â””â”€â”€ live/
â”‚Â  Â  Â  Â â””â”€â”€ 020-spokes/                   # [ì‹¤í–‰] ë¦¬ì „ë³„ í™˜ê²½ ì„¤ì • ì£¼ì…
â”‚Â  Â  Â  Â  Â  Â â””â”€â”€ ap-northeast-2/
â”‚Â  Â  Â  Â  Â  Â  Â  Â â””â”€â”€ network/
â”‚Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â””â”€â”€ terragrunt.hcl

```

---

### 3. í…Œë¼í¼ ëª¨ë“ˆ êµ¬ì„± (Terraform)

#### 3.1 ë³€ìˆ˜ ì •ì˜ (`variables.tf`)

í•œêµ­ ë¦¬ì „ì˜ IP ëŒ€ì—­ ê³„íš(10.10.0.0/16)ì„ ë°˜ì˜í•˜ê³ , ì˜¨í”„ë ˆë¯¸ìŠ¤ ì—°ê²°ì„ ìœ„í•œ ì œì–´ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

```terraform
variable "vpc_cidr" {
  description = "VPCì˜ IP ëŒ€ì—­"
  type        = string
  default     = "10.10.0.0/16"
}

variable "enable_nat" {
  description = "NAT Gateway ìƒì„± ì—¬ë¶€ (ì˜¨í”„ë ˆë¯¸ìŠ¤ ì§ê²° ì‹œ falseë¡œ ì „í™˜ ê°€ëŠ¥)"
  type        = bool
  default     = true 
}

variable "onpre_cidr" {
  description = "ì˜¨í”„ë ˆë¯¸ìŠ¤ IDC ì‚¬ì„¤ IP ëŒ€ì—­"
  type        = string
  default     = "10.20.0.0/16" # ë³µì œ íŠ¸ë˜í”½ í—ˆìš© ëŒ€ì—­
}

variable "public_subnets" {
  type    = list(string)
  default = ["10.10.1.0/24", "10.10.2.0/24"]
}

variable "private_subnets" {
  type    = list(string)
  default = ["10.10.10.0/24", "10.10.11.0/24"]
}

variable "database_subnets" {
  type    = list(string)
  default = ["10.10.20.0/24", "10.10.21.0/24"]
}

```

#### 3.2 í•µì‹¬ ë¡œì§ ë° ë³´ì•ˆ ì„¤ì • (`main.tf`)

í‘œì¤€ VPC êµ¬ì¶•ê³¼ í•¨ê»˜ ì˜¨í”„ë ˆë¯¸ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•œ ë³´ì•ˆ ê·¸ë£¹ì„ ë™ì‹œì— ìƒì„±í•©ë‹ˆë‹¤.

```terraform
# 1. í‘œì¤€ VPC ë„¤íŠ¸ì›Œí¬ êµ¬ì¶•
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = "awskr01-spoke-vpc"
  cidr = var.vpc_cidr

  azs              = ["ap-northeast-2a", "ap-northeast-2c"]
  public_subnets   = var.public_subnets
  private_subnets  = var.private_subnets
  database_subnets = var.database_subnets

  create_database_subnet_group = true

  # ë¹„ìš© ë° í†µì‹  ì œì–´
  enable_nat_gateway = var.enable_nat
  single_nat_gateway = true 

  tags = { Project = "awskr01", Environment = "spoke" }
}

# 2. ì˜¨í”„ë ˆë¯¸ìŠ¤ ì´ì „ì„ ìœ„í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ìš© ë³´ì•ˆ ê·¸ë£¹
resource "aws_security_group" "db_migration_sg" {
  name        = "awskr01-db-migration-sg"
  description = "On-premises IDC replication access"
  vpc_id      = module.vpc.vpc_id

  # ë°ì´í„° ë³µì œë¥¼ ìœ„í•œ DB í¬íŠ¸ í—ˆìš© (ì˜ˆ: MySQL/MariaDB)
  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [var.onpre_cidr]
    description = "Allow DB replication from On-premises"
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

```

---

### 4. ë°°í¬ ì„¤ì • (Terragrunt)

`live` ë””ë ‰í† ë¦¬ì˜ `terragrunt.hcl`ì„ í†µí•´ ì‹¤ì œ í™˜ê²½ì— ê°’ì„ ì£¼ì…í•©ë‹ˆë‹¤.

```hcl
include {
  path = find_in_parent_folders()
}

terraform {
  source = "../../../../modules/aws-network-spoke"
}

inputs = {
  vpc_cidr         = "10.10.0.0/16"
  enable_nat       = true  # ì‹¤ìŠµ ì¤‘ ì¸í„°ë„· í†µì‹ ì„ ìœ„í•´ í™œì„±í™”
  onpre_cidr       = "10.20.0.0/16"
  public_subnets   = ["10.10.1.0/24", "10.10.2.0/24"]
  private_subnets  = ["10.10.10.0/24", "10.10.11.0/24"]
  database_subnets = ["10.10.20.0/24", "10.10.21.0/24"]
}

```

---

### 5. ì‹¤ì „ ì•„í‚¤í…íŠ¸ ê°€ì´ë“œ: ë§ˆì´ê·¸ë ˆì´ì…˜ ìœ ì—°ì„± í™•ë³´ í¬ì¸íŠ¸

ë‹¨ìˆœíˆ ì½”ë“œë¥¼ ë°°í¬í•˜ëŠ” ê²ƒì„ ë„˜ì–´, ë‹¤ìŒì˜ ì „ëµì  ìš”ì†Œë¥¼ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.

1. **DNS ì¶”ìƒí™”**: ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ RDS ì£¼ì†Œë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. **Route 53(ë¼ìš°íŠ¸ 53)** í”„ë¼ì´ë¹— í˜¸ìŠ¤íŒ… ì¡´ì„ ì´ìš©í•´ `db.internal.awskr01` ê°™ì€ ê°€ìƒ ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ë©´, í–¥í›„ DBê°€ ì˜¨í”„ë ˆë¯¸ìŠ¤ë¡œ ì´ë™í•´ë„ ì½”ë“œ ìˆ˜ì • ì—†ì´ DNS ë ˆì½”ë“œë§Œ ë³€ê²½í•˜ì—¬ ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **ì—”ë“œí¬ì¸íŠ¸ í˜¸í™˜ì„±**: AWS ì „ìš© ì—”ì§„ì¸ Auroraë³´ë‹¤ëŠ” ìˆœìˆ˜ MySQL/PostgreSQL ì—”ì§„ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„ì™€ì˜ ë°”ì´ë„ˆë¦¬(Binary) ìˆ˜ì¤€ í˜¸í™˜ì„± ìœ ì§€ì— ìœ ë¦¬í•©ë‹ˆë‹¤.
3. **ê³¼ê¸ˆ ë° ë¹„ìš© ê´€ë¦¬**:
* **NAT Gateway**: ê°œë‹¹ ì‹œê°„ë‹¹ ì•½ **$0.045**ê°€ ë°œìƒí•˜ë¯€ë¡œ ë¯¸ì‚¬ìš© ì‹œ ë°˜ë“œì‹œ ì‚­ì œí•©ë‹ˆë‹¤.
* **ë°ì´í„° ì „ì†¡**: ë³´ì•ˆ ê·¸ë£¹ ìƒì„±ì€ ë¬´ë£Œì´ë‚˜, ì‹¤ì œ ì´ì „ ì‹œ ë°œìƒí•˜ëŠ” **ë°ì´í„° ì „ì†¡ ë¹„ìš©(Data Transfer Out)**ì„ ì˜ˆì‚°ì— ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤.



---

### 6. ì‹¤í–‰ ë° ì†ŒìŠ¤ì½”ë“œ ì €ì¥ ì ˆì°¨

ë³¸ ì½”ë“œëŠ” **ë©±ë“±ì„±**ì´ í™•ë³´ë˜ì–´ ìˆì–´, ìˆ˜ì • ì‚¬í•­ì´ ì—†ë‹¤ë©´ ì—¬ëŸ¬ ë²ˆ `apply`ë¥¼ ì‹¤í–‰í•´ë„ ë™ì¼í•œ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

```bash
# 1. ë°°í¬ ì‹¤í–‰
cd /d/projects/awskr01/infrastructure/live/020-spokes/ap-northeast-2/network
terragrunt init
terragrunt apply -auto-approve

# 2. ìì› ì‚­ì œ (ê³¼ê¸ˆ ë°©ì§€ë¥¼ ìœ„í•´ í•™ìŠµ ì¢…ë£Œ í›„ í•„ìˆ˜ ì‹¤í–‰)
terragrunt destroy -auto-approve

# 3. ì†ŒìŠ¤ì½”ë“œ GitHub ì €ì¥
cd /d/projects/awskr01
git add .
git commit -m "feat: 2ì¼ì°¨ - í•˜ì´ë¸Œë¦¬ë“œ ëŒ€ë¹„í˜• ìŠ¤í¬í¬ ë„¤íŠ¸ì›Œí¬ ë° DB ë§ˆì´ê·¸ë ˆì´ì…˜ SG ì„¤ê³„ ì™„ë£Œ"
git push origin main

```

---

### ğŸ’¡ ì•„í‚¤í…íŠ¸ì˜ ìê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸

* **ë°˜ë³µ ì‹¤í–‰ í™•ì¸**: í…Œë¼í¼ì€ **ì„ ì–¸ì  ì–¸ì–´**ì…ë‹ˆë‹¤. `terragrunt apply`ë¥¼ ë°˜ë³µí•´ë„ AWS ë¦¬ì†ŒìŠ¤ê°€ ì¤‘ë³µ ìƒì„±ë˜ì§€ ì•Šê³ , ì½”ë“œì™€ ì‹¤ì œ ìƒíƒœê°€ ì¼ì¹˜í•˜ëŠ”ì§€ë§Œ í™•ì¸í•˜ë¯€ë¡œ ì•ˆì‹¬í•˜ê³  ì‹¤í–‰í•˜ì…”ë„ ë©ë‹ˆë‹¤.
* **S3 ë°±ì—”ë“œ í™•ì¸**: ëª¨ë“  ì‹¤í–‰ ê¸°ë¡ì€ 1ì¼ì°¨ì— ìƒì„±í•œ S3 ë²„í‚·ì— ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë©ë‹ˆë‹¤.

---

**Next Step: Route 53 í”„ë¼ì´ë¹— í˜¸ìŠ¤íŒ… ì¡´ êµ¬ì„±ì„ í†µí•œ DB ë„ë©”ì¸ ì¶”ìƒí™” ì ìš©**

---

ê°•ì‚¬ë‹˜, ë©±ë“±ì„± ê²€í†  ê²°ê³¼ í…Œë¼í¼ì˜ ìƒíƒœ ê´€ë¦¬ íŒŒì¼(`terraform.tfstate`) ë•ë¶„ì— ë™ì¼í•œ ì½”ë“œë¡œ ì—¬ëŸ¬ ë²ˆ ë°°í¬í•´ë„ ì¤‘ë³µ ìƒì„± ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ê°•ì˜ë¥¼ ì§„í–‰í•˜ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.

Next Step: **Route 53 í”„ë¼ì´ë¹— í˜¸ìŠ¤íŒ… ì¡´ êµ¬ì„±**
