

## 2일차: 온프레미스 중심 글로벌 네트워크 설계 및 하이브리드 대응 구축 (Project: awskr01)

오늘의 목표는 온프레미스 대역(**10.10.0.0/16**)을 기준으로 AWS 글로벌 인프라 대역을 대륙별로 순차 할당하고, 고가용성을 위해 **2개의 가용 영역(Availability Zone A, C)**에 서브넷을 분산 배치하는 것입니다.

### 1. 글로벌 IP 주소 할당 및 서브넷 분할 전략

IP 충돌 방지를 위해 대륙별로 대역을 분리하고, 각 리전 내에서는 가용 영역(AZ)별로 서브넷을 쌍으로 배치하여 인프라의 안정성을 확보합니다.

| 위치 (Role) | 전체 네트워크 대역 (CIDR) | 가용 영역 A (AZ A) | 가용 영역 C (AZ C) | 비고 |
| --- | --- | --- | --- | --- |
| **온프레미스** | **10.10.0.0/16** | - | - | **(기준점)** 사내 IDC 대역 |
| **한국 리전** | **10.20.0.0/16** | 10.20.x.x | 10.20.x.x | 첫 번째 글로벌 스포크 |
| **미국 리전** | **10.30.0.0/16** | 10.30.x.x | 10.30.x.x | 두 번째 글로벌 스포크 |
| **유럽 리전** | **10.40.0.0/16** | 10.40.x.x | 10.40.x.x | 세 번째 글로벌 스포크 |

#### [세부 설계] 한국 리전 스포크 내부 서브넷 (10.20.0.0/16)

| 서브넷 용도 | 가용 영역 A (AZ A) | 가용 영역 C (AZ C) | 주요 역할 |
| --- | --- | --- | --- |
| **Public** | 10.20.1.0/24 | 10.20.2.0/24 | Application Load Balancer(ALB), NAT Gateway |
| **Private EKS** | 10.20.10.0/24 | 10.20.11.0/24 | Elastic Kubernetes Service(EKS) 워커 노드 |
| **Private DB** | **10.20.100.0/24** | **10.20.101.0/24** | RDS Master 및 Read Replica (온프레미스 이관 대비) |

---

### 2. 테라폼 모듈 작성: 하이브리드 대응형 네트워크

**파일 1: `infrastructure/modules/aws-network-spoke/variables.tf**`
기준이 되는 온프레미스 대역부터 순서대로 정의하며, 모든 변수는 표준 형식을 준수합니다.

```terraform
# 1. 온프레미스 IDC 예약 대역 (모든 하이브리드 설계의 기준점)
variable "onprem_cidr" {
  description = "기존에 사용 중인 온프레미스 IDC 네트워크 대역"
  type        = string
  default     = "10.10.0.0/16"
}

# 2. VPC 전체 대역 설정 (한국 10.20, 미국 10.30, 유럽 10.40 계획 반영)
variable "vpc_cidr" {
  description = "AWS VPC의 전체 IP 대역 (리전별로 10단위씩 구분)"
  type        = string
  default     = "10.20.0.0/16"
}

# 3. NAT Gateway 생성 여부 (단독 구축 시 true, 향후 허브 연결 시 false로 변경)
variable "enable_nat" {
  description = "프라이빗 서브넷의 인터넷 통신을 위한 NAT Gateway 활성화 여부"
  type        = bool
  default     = true
}

# 4. 퍼블릭 서브넷 대역 (외부 노출이 필요한 자원 위치)
variable "public_subnets" {
  description = "퍼블릭 서브넷 대역 리스트 (AZ A와 C에 각각 배치)"
  type        = list(string)
  default     = ["10.20.1.0/24", "10.20.2.0/24"]
}

# 5. 프라이빗 서브넷 대역 (EKS 워커 노드 및 애플리케이션 위치)
variable "private_subnets" {
  description = "EKS 전용 프라이빗 서브넷 대역 리스트 (AZ A와 C에 각각 배치)"
  type        = list(string)
  default     = ["10.20.10.0/24", "10.20.11.0/24"]
}

# 6. 데이터베이스 서브넷 대역 (RDS 위치 및 온프레미스 복제 대역)
variable "database_subnets" {
  description = "RDS 전용 프라이빗 서브넷 대역 리스트 (온프레미스 충돌 방지를 위해 100번대 할당)"
  type        = list(string)
  default     = ["10.20.100.0/24", "10.20.101.0/24"]
}

```

**파일 2: `infrastructure/modules/aws-network-spoke/main.tf**`
고가용성을 위해 2개의 가용 영역을 지정하고, 온프레미스 이관용 보안 그룹을 포함합니다.

```terraform
# AWS 공식 VPC 모듈을 사용하여 검증된 네트워크 환경 구축
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = "awskr01-spoke-vpc"
  cidr = var.vpc_cidr

  # 한국 리전(ap-northeast-2)의 A와 C 가용 영역을 사용하여 가용성 확보
  azs              = ["ap-northeast-2a", "ap-northeast-2c"]
  public_subnets   = var.public_subnets
  private_subnets  = var.private_subnets
  database_subnets = var.database_subnets

  # 데이터베이스 서브넷 그룹 자동 생성 (RDS 고가용성 구성에 필수)
  create_database_subnet_group = true

  # NAT Gateway 설정 (EKS 노드의 패치 및 외부 라이브러리 다운로드에 필요)
  enable_nat_gateway = var.enable_nat
  single_nat_gateway = true # 비용 절감을 위해 하나의 가용 영역에만 생성

  tags = {
    Project     = "awskr01"
    Terraform   = "true"
    Environment = "spoke"
  }
}

# 온프레미스(10.10.x.x)와의 데이터베이스 복제 및 이관을 위한 보안 그룹
# 현재 연결 전이라도 설계를 미리 반영하여 인프라의 일관성을 유지함
resource "aws_security_group" "db_migration_security_group" {
  name        = "awskr01-db-migration-sg"
  description = "Allow Database replication traffic from On-premises IDC"
  vpc_id      = module.vpc.vpc_id

  # 온프레미스 IDC 대역(10.10.0.0/16)으로부터의 MySQL/MariaDB(3306) 접근 허용
  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [var.onprem_cidr]
    description = "Allow database replication traffic from On-prem"
  }

  # 모든 아웃바운드 트래픽 허용
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "awskr01-db-migration-sg"
  }
}

```

---

### 3. 테라그란트 설정: 리전별 배포 파일 (Terragrunt)

**파일 3: `infrastructure/live/020-spokes/ap-northeast-2/network/terragrunt.hcl**`

```hcl
include {
  path = find_in_parent_folders()
}

terraform {
  source = "../../../../modules/aws-network-spoke"
}

# 실제 한국 리전에 배포할 구체적인 네트워크 값 주입
inputs = {
  onprem_cidr      = "10.10.0.0/16"
  vpc_cidr         = "10.20.0.0/16"
  enable_nat       = true
  public_subnets   = ["10.20.1.0/24", "10.20.2.0/24"]
  private_subnets  = ["10.20.10.0/24", "10.20.11.0/24"]
  database_subnets = ["10.20.100.0/24", "10.20.101.0/24"]
}

```

---

### 4. 실습 및 배포 절차 (Daily Workflow)

**Step 1: 1일차 공통 인프라 복구**

```bash
cd /d/projects/awskr01/infrastructure/live/000-prepare/ap-northeast-2
terragrunt apply -auto-approve

```

**Step 2: 2일차 네트워크 구축 실행**

```bash
cd ../../../020-spokes/ap-northeast-2/network
terragrunt init
terragrunt apply

```

---

### 5. 작업 종료 및 자원 삭제 (퇴근 절차)

```bash
# 1. 생성된 자원 폐기 (NAT Gateway 등 유료 서비스 과금 방지)
terragrunt destroy -auto-approve
cd ../../../000-prepare/ap-northeast-2
terragrunt destroy -auto-approve

# 2. 변경 사항 버전 관리
cd /d/projects/awskr01
git add .
git commit -m "feat: 온프레미스(10.10) 기준 글로벌 네트워크(10.20~40) 설계 및 고가용성 반영"
git push origin main

```

---

Next Step: 10.20 대역 기반 EKS Cluster 구성 및 AWS Load Balancer Controller 설정
