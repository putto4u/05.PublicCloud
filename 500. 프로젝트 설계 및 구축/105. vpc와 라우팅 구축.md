

## 2일차: 온프레미스 중심 글로벌 네트워크 설계 및 하이브리드 대응 구축 (Project: awskr01)

오늘의 목표는 사내 구축형 전산실인 온프레미스(On-premises) 대역(**10.10.0.0/16**)을 모든 통신의 기준점으로 삼고, AWS 글로벌 인프라 대역을 대륙별로 순차 할당하는 것입니다. 또한, 시스템 장애에 대비한 고가용성(High Availability)을 확보하기 위해 **2개의 가용 영역(Availability Zone A, C)**에 서브넷(Subnet)을 분산 배치합니다.

### 1. 글로벌 IP 주소 할당 및 서브넷 분할 전략

향후 VPN(Virtual Private Network, 가상 사설망)이나 Direct Connect(다이렉트 커넥트, AWS 전용선 서비스)를 통해 클라우드와 사내 전산망을 연결할 때 발생할 수 있는 IP 주소 충돌(IP Conflict)을 원천 차단하기 위해 대륙별로 대역을 엄격하게 분리합니다.

| 위치 (Role) | 전체 네트워크 대역 (CIDR) | 가용 영역 A (AZ A) | 가용 영역 C (AZ C) | 비고 |
| --- | --- | --- | --- | --- |
| **온프레미스** | **10.10.0.0/16** | - | - | **(기준점)** 사내 IDC 대역 |
| **한국 리전** | **10.20.0.0/16** | 10.20.x.x | 10.20.x.x | 첫 번째 글로벌 스포크 |
| **미국 리전** | **10.30.0.0/16** | 10.30.x.x | 10.30.x.x | 두 번째 글로벌 스포크 |
| **유럽 리전** | **10.40.0.0/16** | 10.40.x.x | 10.40.x.x | 세 번째 글로벌 스포크 |

#### [세부 설계] 한국 리전 스포크 내부 서브넷 (10.20.0.0/16)

각 리전 내부의 네트워크는 외부 통신 여부와 보안 수준에 따라 퍼블릭(Public)과 프라이빗(Private)으로 나뉘며, 가용 영역 A와 C에 쌍(Pair)으로 구성됩니다.

| 서브넷 용도 | 가용 영역 A (AZ A) | 가용 영역 C (AZ C) | 주요 역할 |
| --- | --- | --- | --- |
| **Public** | 10.20.1.0/24 | 10.20.2.0/24 | ALB(애플리케이션 로드 밸런서), NAT Gateway(네트워크 주소 변환 게이트웨이) |
| **Private EKS** | 10.20.10.0/24 | 10.20.11.0/24 | EKS(엘라스틱 쿠버네티스 서비스) 워커 노드 및 애플리케이션 |
| **Private DB** | **10.20.100.0/24** | **10.20.101.0/24** | RDS(관계형 데이터베이스 서비스) 구성 및 온프레미스 이관 대비 |

---

### 2. 테라폼 모듈 작성: 하이브리드 대응형 네트워크

이 단계에서는 재사용 가능한 인프라 설계도인 모듈(Module)을 작성합니다.

**파일 1: `infrastructure/modules/aws-network-spoke/variables.tf**`
모든 변수는 데이터 타입(`type`)과 설명(`description`)을 포함하는 표준 형식을 준수하여 명확성을 높입니다.

```terraform
# 1. 온프레미스 IDC 예약 대역 (모든 하이브리드 설계의 기준점)
# 향후 사내 전산실과의 통신을 위해 미리 정의해 두는 변수입니다.
# 0. 배포 타겟 리전 변수
variable "region" {
  description = "인프라가 배포될 AWS 리전"
  type        = string
  default     = "ap-northeast-2"
}



variable "onprem_cidr" {
  description = "기존에 사용 중인 온프레미스 IDC 네트워크 대역"
  type        = string
  default     = "10.10.0.0/16"
}

# 2. VPC(Virtual Private Cloud, 가상 사설 클라우드) 전체 대역 설정
# 한국은 10.20, 미국은 10.30 등 리전별로 10단위씩 구분하여 할당합니다.
variable "vpc_cidr" {
  description = "AWS VPC의 전체 IP 대역"
  type        = string
  default     = "10.20.0.0/16"
}

# 3. NAT Gateway 생성 여부 제어 스위치
# 현재는 독립된 스포크 망이므로 외부 인터넷 통신을 위해 true로 설정합니다.
# 훗날 트래픽을 통제하는 중앙 허브(Hub) 망이 생기면 이 값을 false로 바꾸어 아키텍처를 전환합니다.
variable "enable_nat" {
  description = "프라이빗 서브넷의 인터넷 통신을 위한 NAT Gateway 활성화 여부"
  type        = bool
  default     = false
###########################################################
### 프론트 웹서비스 시작시에는 true로 수정해야 합니다. #####
###########################################################
}

# 4. 퍼블릭 서브넷 대역 (외부 인터넷과 직접 맞닿는 구역)
# 외부 사용자의 요청을 가장 먼저 받는 로드밸런서 등이 위치합니다.
variable "public_subnets" {
  description = "퍼블릭 서브넷 대역 리스트 (AZ A와 C에 각각 배치)"
  type        = list(string)
  default     = ["10.20.1.0/24", "10.20.2.0/24"]
}

# 5. 프라이빗 서브넷 대역 (외부에서 직접 접근할 수 없는 안전한 구역)
# 실제 기업의 핵심 애플리케이션(EKS 워커 노드)이 실행되는 곳입니다.
variable "private_subnets" {
  description = "EKS 전용 프라이빗 서브넷 대역 리스트 (AZ A와 C에 각각 배치)"
  type        = list(string)
  default     = ["10.20.10.0/24", "10.20.11.0/24"]
}

# 6. 데이터베이스 서브넷 대역 (가장 깊숙하고 안전한 구역)
# 데이터베이스가 위치하며, 온프레미스 대역(10.10)과 혼동을 막기 위해 100번대 IP를 부여했습니다.
variable "database_subnets" {
  description = "RDS 전용 프라이빗 서브넷 대역 리스트"
  type        = list(string)
  default     = ["10.20.100.0/24", "10.20.101.0/24"]
}

```

**파일 2: `infrastructure/modules/aws-network-spoke/main.tf**`
정의한 변수들을 바탕으로 실제 AWS 클라우드에 네트워크와 보안 인프라를 구축하는 핵심 로직입니다.

```terraform
# AWS 공식 VPC 모듈을 호출하여 AWS의 권장 표준에 맞춘 네트워크 망을 생성합니다.
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = "awskr01-spoke-vpc"
  cidr = var.vpc_cidr

  # 한국 리전(ap-northeast-2)의 A와 C 가용 영역을 사용하여 물리적인 서버 장애에 대비(고가용성 확보)합니다.
  azs              = ["ap-northeast-2a", "ap-northeast-2c"]
  public_subnets   = var.public_subnets
  private_subnets  = var.private_subnets
  database_subnets = var.database_subnets

  # 데이터베이스 서브넷 그룹 자동 생성 옵션
  # AWS RDS를 다중 가용 영역(Multi-AZ)으로 배포하려면 반드시 서브넷 그룹이 필요합니다.
  create_database_subnet_group = true

  # NAT Gateway 생성 설정
  # 프라이빗 서브넷 안의 서버들이 외부에서 보안 패치 등을 다운로드하기 위해 필요합니다.
  # [과금 주의] NAT Gateway는 생성된 시간당 약 $0.045의 고정 비용이 발생합니다.
  enable_nat_gateway = var.enable_nat
  
  # 비용 절감을 위해 각 가용 영역마다 만들지 않고, 1개의 NAT Gateway만 생성하여 공유합니다.
  single_nat_gateway = true 

  tags = {
    Project     = "awskr01"
    Terraform   = "true"
    Environment = "spoke"
  }
}

# 온프레미스(10.10.x.x)와 AWS 데이터베이스 간의 마이그레이션(데이터 이관) 및 양방향 복제를 위한 방화벽 규칙입니다.
# 실무에서는 인프라를 한 번 생성하면 수정이 까다로우므로, 이처럼 향후 확장될 연결성(Connectivity)을 미리 코드로 열어두는 것이 좋습니다.
resource "aws_security_group" "db_migration_security_group" {
  name        = "awskr01-db-migration-sg"
  description = "Allow Database replication traffic from On-premises IDC"
  
  # 위에서 만든 VPC 내부에 이 보안 그룹을 위치시킵니다.
  vpc_id      = module.vpc.vpc_id

  # 인바운드(Ingress): 외부에서 AWS 안으로 들어오는 트래픽 통제 규칙
  ingress {
    from_port   = 3306 # MySQL/MariaDB 데이터베이스의 기본 통신 포트
    to_port     = 3306
    protocol    = "tcp"
    
    # 인터넷 전체(0.0.0.0/0)가 아닌, 오직 사내 전산실(온프레미스 10.10 대역)에서만 DB 접근을 허용합니다.
    cidr_blocks = [var.onprem_cidr]
    description = "Allow database replication traffic from On-prem"
  }

  # 아웃바운드(Egress): AWS 안에서 외부로 나가는 트래픽 규칙
  # 데이터베이스가 외부에 응답을 주어야 하므로 나가는 길은 모두 열어둡니다.
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1" # 모든 프로토콜 허용
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "awskr01-db-migration-sg"
  }
}

```

---

### 3. 테라그런트 설정: 리전별 배포 파일 (Terragrunt)

작성한 모듈(설계도)에 실제 한국 리전의 값들을 주입하여 실행을 준비하는 파일입니다.

**파일 3: `infrastructure/live/020-spokes/ap-northeast-2/network/terragrunt.hcl**`

```hcl
# 최상위 폴더에 있는 전역 설정(상태 파일을 저장할 S3 백엔드 구성 등)을 자동으로 끌어와 상속받습니다.
include {
  path = find_in_parent_folders()
}

# 적용할 인프라 설계도(모듈)의 위치를 지정합니다.
terraform {
  source = "../../../../modules/aws-network-spoke"
}

# variables.tf에 정의된 변수들에 최종적으로 덮어씌울 실제 값들입니다.
inputs = {
  onprem_cidr      = "10.10.0.0/16"
  vpc_cidr         = "10.20.0.0/16"
  enable_nat       = true
  public_subnets   = ["10.20.1.0/24", "10.20.2.0/24"]
  private_subnets  = ["10.20.10.0/24", "10.20.11.0/24"]
  database_subnets = ["10.20.100.0/24", "10.20.101.0/24"]
}

```

---

### 4. 실습 및 배포 절차 (Daily Workflow)

본격적인 구축을 위해 로컬 PC 터미널에서 다음 명령을 실행합니다.

**Step 1: 1일차 공통 인프라 복구 (사전 작업용 IAM 자원 등)**

```bash
cd /d/projects/awskr01/infrastructure/live/000-prepare/ap-northeast-2
terragrunt apply -auto-approve

```

**Step 2: 2일차 네트워크 및 하이브리드 보안 인프라 구축 실행**

```bash
# 네트워크 실행 디렉토리로 이동
cd ../../../020-spokes/ap-northeast-2/network

# 플러그인 다운로드 및 초기 설정 수행
terragrunt init

# 클라우드에 실제 인프라 배포 (yes 입력하여 승인)
terragrunt apply

```

---

### 5. 작업 종료 및 자원 삭제 (퇴근 절차)

학습이 끝난 후 클라우드 과금을 방지하고 코드를 안전하게 보관하는 절차입니다.

```bash
# 1. 생성된 자원 폐기 (특히 NAT Gateway의 유지 비용을 차단하기 위해 반드시 실행합니다)
terragrunt destroy -auto-approve
cd ../../../000-prepare/ap-northeast-2
terragrunt destroy -auto-approve

# 2. 형상 관리(버전 관리)를 위해 깃허브 원격 저장소에 코드 백업
cd /d/projects/awskr01
git add .
git commit -m "feat: 온프레미스(10.10) 기준 글로벌 네트워크 설계 및 다중 가용영역 기반 하이브리드 인프라 구축 완료"
git push origin main

```

---

### 주석 및 전문 용어 해설

* **CIDR (Classless Inter-Domain Routing, 사이더):** IP 주소를 할당하고 라우팅하는 유연한 방식입니다. `/16`이나 `/24`와 같이 표기하여 네트워크의 크기(사용 가능한 IP 개수)를 결정합니다.
* **NAT Gateway (Network Address Translation Gateway, 네트워크 주소 변환 게이트웨이):** 사설망(Private Subnet) 내부의 서버가 외부 인터넷과 통신할 수 있도록 사설 IP를 공인 IP로 변환해 주는 AWS 관리형 서비스입니다.
* **AZ (Availability Zone, 가용 영역):** 하나의 리전(Region, 예: 서울) 내에 존재하는 물리적으로 완전히 분리된 독립적인 데이터 센터입니다. 2개 이상의 AZ를 사용하면 한 데이터 센터에 화재나 정전이 발생해도 서비스가 중단되지 않습니다.
* **Security Group (보안 그룹):** AWS 내부 자원(EC2, RDS 등)의 앞단에서 들어오고(Ingress) 나가는(Egress) 네트워크 트래픽을 통제하는 방화벽(Firewall) 역할을 합니다.

Next Step: EKS Cluster 구성 및 AWS Load Balancer Controller 배포 준비
